# 宝塔面板部署指南

## 一、环境准备

### 1. 宝塔面板安装软件
在宝塔面板【软件商店】安装以下软件：
- **Nginx** (推荐1.22+)
- **MySQL 8.0**
- **Python项目管理器** (必须)
- **PM2管理器** (可选，用于进程管理)

### 2. 创建数据库
1. 进入【数据库】→【添加数据库】
2. 数据库名：`eceshi`
3. 用户名：`eceshi`
4. 密码：自定义（记住这个密码）
5. 编码：`utf8mb4`

## 二、上传项目代码

### 1. 上传代码
1. 进入【文件】→ `/www/wwwroot/`
2. 上传整个项目文件夹，或使用Git克隆：
```bash
cd /www/wwwroot/
git clone https://github.com/your-repo/eceshi.git
```

### 2. 项目结构
```
/www/wwwroot/eceshi/
├── backend/          # 后端代码
├── frontend/         # 小程序代码（不需要部署到服务器）
├── admin/            # 后台管理（已包含在backend中）
└── ...
```

## 三、配置后端

### 1. 创建Python项目
1. 进入【软件商店】→【Python项目管理器】→【添加项目】
2. 配置如下：
   - **项目名称**：eceshi
   - **项目路径**：`/www/wwwroot/eceshi/backend`
   - **Python版本**：3.10+
   - **框架**：FastAPI
   - **启动方式**：uvicorn
   - **启动文件**：app.main:app
   - **端口**：8000
   - **运行用户**：www

### 2. 安装依赖
在Python项目管理器中，点击【终端】或SSH连接服务器：
```bash
cd /www/wwwroot/eceshi/backend
source /www/server/pyenv/versions/3.10.x/bin/activate  # 激活虚拟环境
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
```

### 3. 配置环境变量
创建 `/www/wwwroot/eceshi/backend/.env` 文件：
```env
# 应用配置
APP_NAME=科研检测服务平台
APP_VERSION=1.0.0
DEBUG=false
HOST=0.0.0.0
PORT=8000

# 数据库配置（修改为你的数据库信息）
DATABASE_URL=mysql+pymysql://eceshi:你的数据库密码@127.0.0.1:3306/eceshi?charset=utf8mb4

# JWT密钥（生成一个随机字符串）
JWT_SECRET_KEY=your-super-secret-key-change-this-in-production
JWT_ALGORITHM=HS256
JWT_EXPIRE_HOURS=168

# CORS配置
CORS_ORIGINS=["https://你的域名.com","https://www.你的域名.com"]

# 阿里云短信配置
ALIYUN_ACCESS_KEY_ID=你的AccessKeyId
ALIYUN_ACCESS_KEY_SECRET=你的AccessKeySecret
ALIYUN_SMS_SIGN_NAME=你的短信签名
ALIYUN_SMS_TEMPLATE_CODE=你的模板代码

# 支付配置（可选）
ALIPAY_APP_ID=
ALIPAY_PRIVATE_KEY=
ALIPAY_PUBLIC_KEY=
WECHAT_APP_ID=
WECHAT_MCH_ID=
WECHAT_API_KEY=
```

### 4. 初始化数据库
```bash
cd /www/wwwroot/eceshi/backend
python init_db.py
python insert_sample_data.py  # 插入示例数据（可选）
```

### 5. 启动项目
在Python项目管理器中点击【启动】，或使用命令：
```bash
cd /www/wwwroot/eceshi/backend
nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &
```

## 四、配置Nginx

### 1. 创建网站
1. 进入【网站】→【添加站点】
2. 域名：`你的域名.com`
3. PHP版本：纯静态
4. 根目录：`/www/wwwroot/eceshi/backend`

### 2. 配置Nginx反向代理
点击网站【设置】→【配置文件】，替换为：

```nginx
server {
    listen 80;
    listen 443 ssl http2;
    server_name 你的域名.com www.你的域名.com;
    
    # SSL证书配置（使用宝塔自动申请的Let's Encrypt证书）
    ssl_certificate    /www/server/panel/vhost/cert/你的域名.com/fullchain.pem;
    ssl_certificate_key    /www/server/panel/vhost/cert/你的域名.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
    ssl_prefer_server_ciphers on;
    
    # 强制HTTPS
    if ($server_port !~ 443) {
        rewrite ^(/.*)$ https://$host$1 permanent;
    }
    
    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }
    
    # PC网站
    location /web {
        alias /www/wwwroot/eceshi/backend/static/web;
        index index.html;
        try_files $uri $uri/ /web/index.html;
    }
    
    # 后台管理
    location /admin {
        alias /www/wwwroot/eceshi/backend/admin;
        index index.html;
        try_files $uri $uri/ /admin/index.html;
    }
    
    # 静态文件
    location /static {
        alias /www/wwwroot/eceshi/backend/static;
    }
    
    # API反向代理
    location /api {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
    }
    
    # 健康检查
    location /health {
        proxy_pass http://127.0.0.1:8000;
    }
    
    # 根路径
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
    
    # 禁止访问敏感文件
    location ~ /\. {
        deny all;
    }
    
    location ~ \.env$ {
        deny all;
    }
    
    # 访问日志
    access_log /www/wwwlogs/eceshi.log;
    error_log /www/wwwlogs/eceshi.error.log;
}
```

### 3. 申请SSL证书
1. 点击网站【设置】→【SSL】
2. 选择【Let's Encrypt】→【申请】
3. 勾选【强制HTTPS】

## 五、配置进程守护

### 方法1：使用Supervisor（推荐）
1. 安装Supervisor：
```bash
pip install supervisor
```

2. 创建配置文件 `/etc/supervisor/conf.d/eceshi.conf`：
```ini
[program:eceshi]
command=/www/server/pyenv/versions/3.10.x/bin/python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
directory=/www/wwwroot/eceshi/backend
user=www
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/www/wwwlogs/eceshi_supervisor.log
```

3. 启动：
```bash
supervisorctl reread
supervisorctl update
supervisorctl start eceshi
```

### 方法2：使用宝塔Python项目管理器
在Python项目管理器中开启【开机启动】

## 六、小程序配置

### 1. 修改API地址
编辑 `frontend/utils/request.js`：
```javascript
const BASE_URL = 'https://你的域名.com'
```

### 2. 编译发布
```bash
cd frontend
npm run build:mp-weixin
```

### 3. 上传到微信开发者工具
1. 打开微信开发者工具
2. 导入 `frontend/unpackage/dist/build/mp-weixin`
3. 上传并提交审核

## 七、验证部署

### 1. 检查服务状态
```bash
# 检查后端是否运行
curl http://127.0.0.1:8000/health

# 检查Nginx配置
nginx -t

# 查看日志
tail -f /www/wwwlogs/eceshi.log
tail -f /www/wwwroot/eceshi/backend/server.log
```

### 2. 访问测试
- 后端API：https://你的域名.com/api/docs
- PC网站：https://你的域名.com/web
- 后台管理：https://你的域名.com/admin

### 3. 测试账号
- 管理员：18888888888 / 验证码：123456
- 普通用户：注册新账号

## 八、常见问题

### 1. 502 Bad Gateway
- 检查后端是否启动：`ps aux | grep uvicorn`
- 检查端口是否被占用：`lsof -i:8000`
- 查看后端日志：`tail -100 /www/wwwroot/eceshi/backend/server.log`

### 2. 数据库连接失败
- 检查数据库用户权限
- 检查.env中的数据库配置
- 确保MySQL服务正常运行

### 3. 静态文件404
- 检查Nginx配置中的路径是否正确
- 检查文件权限：`chown -R www:www /www/wwwroot/eceshi`

### 4. CORS跨域错误
- 检查.env中的CORS_ORIGINS配置
- 确保包含所有需要访问的域名

## 九、维护命令

```bash
# 重启后端
supervisorctl restart eceshi
# 或
cd /www/wwwroot/eceshi/backend
pkill -f "uvicorn app.main"
nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > server.log 2>&1 &

# 重启Nginx
systemctl restart nginx
# 或
/etc/init.d/nginx restart

# 查看日志
tail -f /www/wwwroot/eceshi/backend/server.log

# 更新代码
cd /www/wwwroot/eceshi
git pull
supervisorctl restart eceshi
```

## 十、备份策略

### 1. 数据库备份
在宝塔【计划任务】中添加：
- 任务类型：备份数据库
- 备份周期：每天凌晨3点
- 保留份数：7份

### 2. 文件备份
在宝塔【计划任务】中添加：
- 任务类型：备份网站
- 备份周期：每周日凌晨4点
- 保留份数：4份

---

部署完成后，您的系统将可通过以下地址访问：
- **PC网站**：https://你的域名.com/web
- **后台管理**：https://你的域名.com/admin
- **API文档**：https://你的域名.com/api/docs
- **小程序**：微信搜索您的小程序名称

