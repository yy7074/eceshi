# 第二迭代：下单与支付功能

**迭代周期**: 第5-7周（3周）
**状态**: 🚀 准备启动
**优先级**: P0（核心功能）

---

## 📋 迭代目标

完成用户下单、支付、订单管理的完整流程，形成交易闭环。

### 核心目标
1. ✅ 用户可以选择检测项目并下单
2. ✅ 支持多种支付方式（支付宝、微信、余额）
3. ✅ 订单状态完整流转
4. ✅ 实验室接单与订单管理
5. ✅ 用户查看订单详情和进度

---

## 🎯 功能清单

### 一、前端开发（uni-app）

#### 1. 下单流程页面

**页面路径**: `/pagesA/booking/booking.vue`

**功能点**:
- [ ] 项目信息展示（名称、价格、实验室）
- [ ] 样品信息填写
  - 样品名称
  - 样品描述
  - 样品数量
  - 样品照片上传
- [ ] 检测需求填写
  - 检测参数选择
  - 特殊要求说明
  - 期望完成时间
- [ ] 物流方式选择
  - 自送样品（免运费）
  - 快递寄送（到付）
  - 平台代收（运费预付）
- [ ] 收样地址选择
  - 实验室地址显示
  - 联系人和电话
- [ ] 费用明细展示
  - 检测费用
  - 加急费用
  - 运费
  - 优惠券抵扣
  - 积分抵扣
  - 总计金额
- [ ] 支付方式选择
  - 在线支付（支付宝、微信）
  - 余额支付
  - 信用额度支付
  - 混合支付
- [ ] 提交订单

**UI设计要点**:
- 分步骤展示（样品→需求→物流→支付）
- 实时计算费用
- 表单验证提示
- 支持保存草稿

---

#### 2. 支付页面

**页面路径**: `/pagesA/payment/payment.vue`

**功能点**:
- [ ] 订单信息确认
- [ ] 支付金额展示
- [ ] 支付方式选择
  - 支付宝支付
  - 微信支付
  - 余额支付
  - 组合支付
- [ ] 支付密码输入（余额支付）
- [ ] 调起支付SDK
- [ ] 支付结果处理
  - 成功→订单详情
  - 失败→重试或取消
  - 超时→订单列表

**关键逻辑**:
```javascript
// 支付流程
1. 创建支付订单
2. 获取支付参数
3. 调起支付
4. 轮询支付结果
5. 跳转结果页
```

---

#### 3. 订单详情页面

**页面路径**: `/pagesA/order-detail/order-detail.vue`

**功能点**:
- [ ] 订单状态展示
  - 状态时间轴
  - 当前状态说明
  - 下一步操作提示
- [ ] 订单基本信息
  - 订单号
  - 创建时间
  - 项目名称
  - 实验室名称
- [ ] 样品信息
  - 样品列表
  - 样品照片
  - 物流信息
- [ ] 检测需求详情
- [ ] 费用明细
- [ ] 实验进度（实验中状态）
  - 进度百分比
  - 关键节点
  - 预计完成时间
- [ ] 操作按钮
  - 待支付：去支付、取消订单
  - 待确认：确认接收、联系实验室
  - 待试验：查看物流、催单
  - 实验中：查看进度、沟通
  - 已完成：下载数据、申请开票、评价
  - 已取消：删除订单、再次购买

**状态流转图**:
```
待支付 → 待确认 → 待试验 → 实验中 → 已完成
   ↓         ↓         ↓                    ↓
 已取消    已取消    已取消              已评价
```

---

#### 4. 物流信息页面

**页面路径**: `/pagesA/logistics/logistics.vue`

**功能点**:
- [ ] 物流公司
- [ ] 物流单号
- [ ] 物流状态
- [ ] 物流轨迹时间线
- [ ] 联系快递员
- [ ] 复制单号

---

#### 5. 地址管理页面

**页面路径**: `/pagesA/address/address.vue`

**功能点**:
- [ ] 地址列表展示
- [ ] 添加新地址
- [ ] 编辑地址
- [ ] 删除地址
- [ ] 设置默认地址
- [ ] 地址选择（下单时）

**地址信息**:
- 收件人姓名
- 手机号
- 省市区
- 详细地址
- 是否默认

---

#### 6. 优惠券页面

**页面路径**: `/pagesA/coupon/coupon.vue`

**功能点**:
- [ ] 可用优惠券列表
- [ ] 不可用优惠券列表
- [ ] 已使用优惠券列表
- [ ] 优惠券详情（使用条件）
- [ ] 优惠券兑换
- [ ] 优惠券选择（下单时）

---

### 二、后端开发（Python + FastAPI）

#### 1. 数据库设计

**新增表结构**:

```sql
-- 订单主表
CREATE TABLE orders (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_no VARCHAR(32) UNIQUE NOT NULL COMMENT '订单号',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    project_id BIGINT NOT NULL COMMENT '项目ID',
    lab_id BIGINT NOT NULL COMMENT '实验室ID',
    status VARCHAR(20) NOT NULL COMMENT '订单状态',
    
    -- 费用信息
    project_fee DECIMAL(10,2) NOT NULL COMMENT '项目费用',
    urgent_fee DECIMAL(10,2) DEFAULT 0 COMMENT '加急费用',
    shipping_fee DECIMAL(10,2) DEFAULT 0 COMMENT '运费',
    discount_amount DECIMAL(10,2) DEFAULT 0 COMMENT '优惠金额',
    total_fee DECIMAL(10,2) NOT NULL COMMENT '总金额',
    paid_fee DECIMAL(10,2) DEFAULT 0 COMMENT '已支付金额',
    
    -- 支付信息
    payment_method VARCHAR(20) COMMENT '支付方式',
    payment_time DATETIME COMMENT '支付时间',
    
    -- 时间信息
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    paid_at DATETIME COMMENT '支付时间',
    confirmed_at DATETIME COMMENT '确认时间',
    started_at DATETIME COMMENT '开始实验时间',
    completed_at DATETIME COMMENT '完成时间',
    cancelled_at DATETIME COMMENT '取消时间',
    
    -- 其他
    remark TEXT COMMENT '备注',
    cancel_reason VARCHAR(200) COMMENT '取消原因',
    
    INDEX idx_user_id (user_id),
    INDEX idx_lab_id (lab_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
) COMMENT '订单主表';

-- 订单样品表
CREATE TABLE order_samples (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    sample_name VARCHAR(100) NOT NULL COMMENT '样品名称',
    sample_type VARCHAR(50) COMMENT '样品类型',
    sample_desc TEXT COMMENT '样品描述',
    quantity INT DEFAULT 1 COMMENT '样品数量',
    photos JSON COMMENT '样品照片',
    
    -- 检测参数
    test_params JSON COMMENT '检测参数',
    special_requirements TEXT COMMENT '特殊要求',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_order_id (order_id)
) COMMENT '订单样品表';

-- 订单费用明细表
CREATE TABLE order_fees (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    fee_type VARCHAR(20) NOT NULL COMMENT '费用类型',
    fee_name VARCHAR(50) NOT NULL COMMENT '费用名称',
    amount DECIMAL(10,2) NOT NULL COMMENT '金额',
    remark VARCHAR(200) COMMENT '备注',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_order_id (order_id)
) COMMENT '订单费用明细表';

-- 订单状态流转表
CREATE TABLE order_status_history (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    from_status VARCHAR(20) COMMENT '原状态',
    to_status VARCHAR(20) NOT NULL COMMENT '新状态',
    operator_id BIGINT COMMENT '操作人ID',
    operator_type VARCHAR(20) COMMENT '操作人类型',
    remark VARCHAR(200) COMMENT '备注',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_order_id (order_id)
) COMMENT '订单状态流转表';

-- 支付记录表
CREATE TABLE payments (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    payment_no VARCHAR(32) UNIQUE NOT NULL COMMENT '支付单号',
    order_id BIGINT NOT NULL COMMENT '订单ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',
    
    payment_method VARCHAR(20) NOT NULL COMMENT '支付方式',
    payment_channel VARCHAR(20) COMMENT '支付渠道',
    amount DECIMAL(10,2) NOT NULL COMMENT '支付金额',
    
    status VARCHAR(20) NOT NULL COMMENT '支付状态',
    trade_no VARCHAR(64) COMMENT '第三方交易号',
    
    paid_at DATETIME COMMENT '支付时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_order_id (order_id),
    INDEX idx_user_id (user_id),
    INDEX idx_trade_no (trade_no)
) COMMENT '支付记录表';

-- 物流信息表
CREATE TABLE logistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL COMMENT '订单ID',
    logistics_type VARCHAR(20) NOT NULL COMMENT '物流类型',
    
    shipping_method VARCHAR(20) COMMENT '配送方式',
    logistics_company VARCHAR(50) COMMENT '物流公司',
    tracking_no VARCHAR(50) COMMENT '物流单号',
    
    -- 发货信息
    sender_name VARCHAR(50) COMMENT '发件人',
    sender_phone VARCHAR(20) COMMENT '发件人电话',
    sender_address VARCHAR(200) COMMENT '发件地址',
    
    -- 收货信息
    receiver_name VARCHAR(50) COMMENT '收件人',
    receiver_phone VARCHAR(20) COMMENT '收件人电话',
    receiver_address VARCHAR(200) COMMENT '收件地址',
    
    -- 物流状态
    status VARCHAR(20) COMMENT '物流状态',
    current_location VARCHAR(100) COMMENT '当前位置',
    
    shipped_at DATETIME COMMENT '发货时间',
    received_at DATETIME COMMENT '签收时间',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_order_id (order_id)
) COMMENT '物流信息表';

-- 收货地址表
CREATE TABLE user_addresses (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    
    receiver_name VARCHAR(50) NOT NULL COMMENT '收件人',
    phone VARCHAR(20) NOT NULL COMMENT '手机号',
    province VARCHAR(50) NOT NULL COMMENT '省',
    city VARCHAR(50) NOT NULL COMMENT '市',
    district VARCHAR(50) COMMENT '区',
    detail_address VARCHAR(200) NOT NULL COMMENT '详细地址',
    
    is_default BOOLEAN DEFAULT FALSE COMMENT '是否默认',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id)
) COMMENT '用户地址表';

-- 优惠券表
CREATE TABLE coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    coupon_no VARCHAR(32) UNIQUE NOT NULL COMMENT '优惠券编号',
    
    name VARCHAR(100) NOT NULL COMMENT '优惠券名称',
    type VARCHAR(20) NOT NULL COMMENT '类型',
    discount_type VARCHAR(20) NOT NULL COMMENT '优惠类型',
    discount_value DECIMAL(10,2) NOT NULL COMMENT '优惠值',
    
    -- 使用条件
    min_amount DECIMAL(10,2) DEFAULT 0 COMMENT '最低消费',
    max_discount DECIMAL(10,2) COMMENT '最高优惠',
    applicable_categories JSON COMMENT '适用分类',
    applicable_projects JSON COMMENT '适用项目',
    
    -- 有效期
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME NOT NULL COMMENT '结束时间',
    
    -- 发放量
    total_quantity INT COMMENT '总量',
    issued_quantity INT DEFAULT 0 COMMENT '已发放',
    used_quantity INT DEFAULT 0 COMMENT '已使用',
    
    status VARCHAR(20) DEFAULT 'active' COMMENT '状态',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_status (status)
) COMMENT '优惠券表';

-- 用户优惠券表
CREATE TABLE user_coupons (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    coupon_id BIGINT NOT NULL COMMENT '优惠券ID',
    
    status VARCHAR(20) DEFAULT 'unused' COMMENT '状态',
    
    order_id BIGINT COMMENT '使用订单ID',
    used_at DATETIME COMMENT '使用时间',
    
    start_time DATETIME NOT NULL COMMENT '开始时间',
    end_time DATETIME NOT NULL COMMENT '结束时间',
    
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_user_id (user_id),
    INDEX idx_status (status)
) COMMENT '用户优惠券表';
```

---

#### 2. API接口设计

**订单模块** (`/api/v1/orders`)

```python
# 创建订单
POST /api/v1/orders/create
{
    "project_id": 1,
    "samples": [
        {
            "name": "样品A",
            "type": "粉末",
            "desc": "白色粉末",
            "quantity": 1,
            "test_params": {},
            "photos": []
        }
    ],
    "shipping_method": "express",
    "address_id": 1,
    "coupon_id": null,
    "use_points": 0,
    "remark": "加急处理"
}

# 计算订单费用（下单前）
POST /api/v1/orders/calculate
{
    "project_id": 1,
    "sample_count": 3,
    "is_urgent": false,
    "shipping_method": "express",
    "coupon_id": null,
    "use_points": 100
}

# 获取订单列表
GET /api/v1/orders/list?status=all&page=1&page_size=10

# 获取订单详情
GET /api/v1/orders/{order_id}

# 取消订单
POST /api/v1/orders/{order_id}/cancel
{
    "reason": "不想买了"
}

# 确认收样（用户确认实验室收到样品）
POST /api/v1/orders/{order_id}/confirm-receipt

# 订单评价
POST /api/v1/orders/{order_id}/evaluate
{
    "rating": 5,
    "content": "服务很好",
    "tags": ["专业", "快速"],
    "images": []
}
```

**支付模块** (`/api/v1/payments`)

```python
# 创建支付
POST /api/v1/payments/create
{
    "order_id": 1,
    "payment_method": "alipay",  # alipay, wechat, balance
    "amount": 936.00
}

# 支付宝支付
POST /api/v1/payments/alipay
{
    "order_id": 1
}

# 微信支付
POST /api/v1/payments/wechat
{
    "order_id": 1
}

# 余额支付
POST /api/v1/payments/balance
{
    "order_id": 1,
    "payment_password": "******"
}

# 查询支付状态
GET /api/v1/payments/{payment_id}/status

# 支付回调（第三方）
POST /api/v1/payments/alipay/notify
POST /api/v1/payments/wechat/notify
```

**地址模块** (`/api/v1/addresses`)

```python
# 获取地址列表
GET /api/v1/addresses/list

# 添加地址
POST /api/v1/addresses/add
{
    "receiver_name": "张三",
    "phone": "13800138000",
    "province": "北京市",
    "city": "北京市",
    "district": "海淀区",
    "detail_address": "清华大学",
    "is_default": true
}

# 更新地址
PUT /api/v1/addresses/{address_id}

# 删除地址
DELETE /api/v1/addresses/{address_id}

# 设置默认地址
POST /api/v1/addresses/{address_id}/set-default
```

**优惠券模块** (`/api/v1/coupons`)

```python
# 获取可用优惠券
GET /api/v1/coupons/available?project_id=1&amount=1000

# 获取我的优惠券
GET /api/v1/coupons/my?status=unused

# 兑换优惠券
POST /api/v1/coupons/redeem
{
    "coupon_code": "ABC123"
}
```

**物流模块** (`/api/v1/logistics`)

```python
# 获取物流信息
GET /api/v1/logistics/{order_id}

# 获取物流轨迹
GET /api/v1/logistics/{order_id}/traces
```

---

#### 3. 业务逻辑

**订单状态机**:
```python
class OrderStatus(str, Enum):
    PENDING_PAYMENT = "pending_payment"      # 待支付
    CONFIRMED = "confirmed"                  # 已确认（实验室确认接单）
    WAITING_TEST = "waiting_test"            # 待试验（等待样品）
    IN_PROGRESS = "in_progress"              # 实验中
    COMPLETED = "completed"                  # 已完成
    CANCELLED = "cancelled"                  # 已取消

# 状态流转规则
STATUS_FLOW = {
    PENDING_PAYMENT: [CONFIRMED, CANCELLED],
    CONFIRMED: [WAITING_TEST, CANCELLED],
    WAITING_TEST: [IN_PROGRESS, CANCELLED],
    IN_PROGRESS: [COMPLETED],
    COMPLETED: [],
    CANCELLED: []
}
```

**支付流程**:
```python
1. 用户选择支付方式
2. 后端创建支付订单
3. 调用支付渠道SDK
4. 返回支付参数给前端
5. 前端调起支付
6. 支付完成后回调
7. 更新订单状态
8. 通知用户
```

**订单取消规则**:
- 待支付：用户随时可取消，无需退款
- 已确认：用户申请取消，实验室同意后退款
- 待试验：用户申请取消，实验室同意后退款（可能扣除部分费用）
- 实验中：不可取消

---

### 三、第三方集成

#### 1. 支付集成

**支付宝**:
- SDK: `alipay-sdk-python`
- 接入方式: Web支付 / App支付 / 小程序支付
- 文档: https://opendocs.alipay.com/

**微信支付**:
- SDK: `wechatpy`
- 接入方式: JSAPI支付 / App支付 / Native支付
- 文档: https://pay.weixin.qq.com/

#### 2. 物流查询

**快递100**:
- API: 快递查询接口
- 功能: 获取物流轨迹
- 文档: https://www.kuaidi100.com/

---

## 📅 开发排期

### 第5周：数据库与订单基础

**后端**（3天）:
- [ ] 数据库表设计与创建
- [ ] 订单模型定义
- [ ] 订单创建接口
- [ ] 订单查询接口
- [ ] 订单状态流转逻辑

**前端**（2天）:
- [ ] 下单页面UI
- [ ] 样品信息表单
- [ ] 费用计算展示

---

### 第6周：支付与地址管理

**后端**（3天）:
- [ ] 支付模块设计
- [ ] 支付宝集成
- [ ] 微信支付集成
- [ ] 余额支付
- [ ] 支付回调处理
- [ ] 地址管理接口

**前端**（2天）:
- [ ] 支付页面
- [ ] 地址管理页面
- [ ] 地址选择组件
- [ ] 支付结果页面

---

### 第7周：订单详情与物流

**后端**（2天）:
- [ ] 订单详情接口完善
- [ ] 物流信息接口
- [ ] 物流轨迹查询
- [ ] 优惠券接口

**前端**（3天）:
- [ ] 订单详情页面
- [ ] 物流信息页面
- [ ] 优惠券页面
- [ ] 订单评价页面
- [ ] 整体测试与优化

---

## 🧪 测试计划

### 功能测试
- [ ] 下单流程完整测试
- [ ] 各支付方式测试
- [ ] 订单状态流转测试
- [ ] 订单取消与退款测试
- [ ] 地址管理测试
- [ ] 优惠券使用测试

### 异常测试
- [ ] 支付超时处理
- [ ] 支付失败处理
- [ ] 重复支付防范
- [ ] 订单并发处理
- [ ] 网络异常处理

### 性能测试
- [ ] 订单列表加载速度
- [ ] 支付响应时间
- [ ] 并发下单压测

---

## 📊 验收标准

### 功能完整性
- ✅ 用户可以完整走通下单流程
- ✅ 支持至少2种支付方式
- ✅ 订单状态正确流转
- ✅ 支付成功后订单状态更新
- ✅ 可以查看订单详情和物流

### 用户体验
- ✅ 下单流程顺畅，无卡顿
- ✅ 表单验证提示友好
- ✅ 支付操作简单明了
- ✅ 订单信息展示清晰

### 代码质量
- ✅ 代码注释完整
- ✅ 错误处理完善
- ✅ 接口响应统一
- ✅ 数据库设计规范

---

## 🔗 相关文档

- [支付宝开放平台](https://opendocs.alipay.com/)
- [微信支付文档](https://pay.weixin.qq.com/wiki/doc/api/)
- [快递100 API](https://www.kuaidi100.com/openapi/api_post.shtml)

---

**准备就绪，随时开始第二迭代！** 🚀

