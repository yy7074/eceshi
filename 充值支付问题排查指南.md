# å……å€¼æ”¯ä»˜é—®é¢˜æ’æŸ¥æŒ‡å—

## âŒ é—®é¢˜æè¿°

**é”™è¯¯ä¿¡æ¯**ï¼šæ”¯ä»˜ ç¼ºå°‘å‚æ•° total_fee

---

## âœ… å·²ä¼˜åŒ–çš„å†…å®¹

### 1. æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡º
åœ¨ `wechatpay_service.py` ä¸­æ·»åŠ äº†è°ƒè¯•æ—¥å¿—ï¼š
```python
print(f"[å……å€¼] åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•:")
print(f"  - å……å€¼å•å·: {recharge.recharge_no}")
print(f"  - å……å€¼é‡‘é¢: {recharge.amount}å…ƒ ({total_fee}åˆ†)")
print(f"  - ç”¨æˆ·OpenID: {openid}")
print(f"  - å•†æˆ·å·: {self.mch_id}")
print(f"[å……å€¼] ç»Ÿä¸€ä¸‹å•å‚æ•°: {params}")
```

### 2. æ·»åŠ äº†é‡‘é¢éªŒè¯
```python
# ç¡®ä¿é‡‘é¢å¤§äº0
if total_fee <= 0:
    raise ValueError(f"å……å€¼é‡‘é¢å¿…é¡»å¤§äº0ï¼Œå½“å‰é‡‘é¢: {recharge.amount}")
```

### 3. ç»Ÿä¸€ä¸‹å•å‚æ•°
ç¡®ä¿ `total_fee` å‚æ•°æ­£ç¡®ä¼ é€’ï¼š
```python
params = {
    'appid': self.app_id,
    'mch_id': self.mch_id,
    'nonce_str': self.generate_nonce_str(),
    'body': f'é’±åŒ…å……å€¼',
    'out_trade_no': recharge.recharge_no,
    'total_fee': str(total_fee),  # âœ… ç¡®ä¿è½¬ä¸ºå­—ç¬¦ä¸²
    'spbill_create_ip': '127.0.0.1',
    'notify_url': self.notify_url.replace('/payments/wechat/notify', '/recharge/wechat/notify'),
    'trade_type': 'JSAPI',
    'openid': openid
}
```

---

## ğŸ” æ’æŸ¥æ­¥éª¤

### æ­¥éª¤1ï¼šæŸ¥çœ‹åç«¯æ—¥å¿—

é‡å¯åç«¯æœåŠ¡å¹¶æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼š

```bash
cd backend
python -m app.main
```

å½“ä½ ç‚¹å‡»å……å€¼æ—¶ï¼Œåº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
[å……å€¼] åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•:
  - å……å€¼å•å·: RC1697788800123456
  - å……å€¼é‡‘é¢: 100.0å…ƒ (10000åˆ†)
  - ç”¨æˆ·OpenID: oXXXXXXXXXXXXXX
  - å•†æˆ·å·: 10026954
[å……å€¼] ç»Ÿä¸€ä¸‹å•å‚æ•°: {'appid': 'wx2ef4744e64c7bc45', 'mch_id': '10026954', ...}
```

### æ­¥éª¤2ï¼šæ£€æŸ¥å……å€¼é‡‘é¢

ç¡®è®¤å‰ç«¯å‘é€çš„å……å€¼é‡‘é¢æ­£ç¡®ï¼š

**å‰ç«¯ä»£ç æ£€æŸ¥** (`recharge.vue`):
```javascript
async doRecharge() {
  // ç¡®è®¤ finalAmount æœ‰å€¼
  console.log('å……å€¼é‡‘é¢:', this.finalAmount)
  
  const res = await api.createRecharge({
    amount: this.finalAmount,  // âœ… å¿…é¡»å¤§äº0
    payment_method: 'wechat'
  })
}
```

### æ­¥éª¤3ï¼šæ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€

ç¡®è®¤ç”¨æˆ·å·²ä½¿ç”¨å¾®ä¿¡ç™»å½•ï¼ˆæœ‰openidï¼‰ï¼š

```bash
# åœ¨åç«¯æ—¥å¿—ä¸­æŸ¥æ‰¾
[å……å€¼] ç”¨æˆ·OpenID: oXXXXXXXXXXXXXX  # âœ… åº”è¯¥æœ‰å€¼
```

å¦‚æœæ˜¾ç¤º `None` æˆ–ä¸ºç©ºï¼Œè¯´æ˜ç”¨æˆ·æœªå¾®ä¿¡ç™»å½•ã€‚

### æ­¥éª¤4ï¼šæ£€æŸ¥å•†æˆ·å·é…ç½®

æŸ¥çœ‹ `.env` æ–‡ä»¶ï¼š
```bash
cd backend
cat .env | grep WECHAT
```

åº”è¯¥çœ‹åˆ°ï¼š
```
WECHAT_APPID=wx2ef4744e64c7bc45
WECHAT_SECRET=80d47eff16201ebcd596c40d591d86dc
WECHAT_MCH_ID=10026954
WECHAT_PAY_KEY=fr54thyu78kijfsqv46mkl956edfg3ed
```

---

## ğŸ› å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šé‡‘é¢ä¸º0æˆ–ç©º

**ç°è±¡**ï¼š
```
[å……å€¼] å……å€¼é‡‘é¢: 0.0å…ƒ (0åˆ†)
ValueError: å……å€¼é‡‘é¢å¿…é¡»å¤§äº0
```

**åŸå› **ï¼š
- å‰ç«¯æœªé€‰æ‹©é‡‘é¢
- è‡ªå®šä¹‰é‡‘é¢è¾“å…¥ä¸ºç©º

**è§£å†³**ï¼š
```javascript
// å‰ç«¯æ·»åŠ éªŒè¯
if (!this.finalAmount || this.finalAmount < 0.01) {
  uni.showToast({ title: 'è¯·è¾“å…¥å……å€¼é‡‘é¢', icon: 'none' })
  return
}
```

### é—®é¢˜2ï¼šç”¨æˆ·æœªå¾®ä¿¡ç™»å½•

**ç°è±¡**ï¼š
```
HTTPException: è¯·å…ˆä½¿ç”¨å¾®ä¿¡ç™»å½•
```

**åŸå› **ï¼š
- ç”¨æˆ·æœªä½¿ç”¨å¾®ä¿¡ç™»å½•
- current_user.wechat_openid ä¸º None

**è§£å†³**ï¼š
1. å¼•å¯¼ç”¨æˆ·ä½¿ç”¨å¾®ä¿¡ç™»å½•
2. æ£€æŸ¥å¾®ä¿¡ç™»å½•åŠŸèƒ½æ˜¯å¦æ­£å¸¸

### é—®é¢˜3ï¼šå•†æˆ·å·æˆ–å¯†é’¥æœªé…ç½®

**ç°è±¡**ï¼š
```
[å……å€¼] ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜å‚æ•°
```

**è¯´æ˜**ï¼š
- è¿™æ˜¯æ­£å¸¸çš„ï¼ˆç”¨äºæµ‹è¯•ï¼‰
- ä¼šè¿”å›æ¨¡æ‹Ÿçš„æ”¯ä»˜å‚æ•°
- å¯ä»¥è°ƒèµ·æ”¯ä»˜ä½†ä¸ä¼šçœŸå®æ‰£æ¬¾

**è§£å†³**ï¼š
- å¼€å‘æµ‹è¯•ï¼šå¯ä»¥ç»§ç»­ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼
- ç”Ÿäº§ç¯å¢ƒï¼šé…ç½®çœŸå®çš„å•†æˆ·å·å’Œå¯†é’¥

### é—®é¢˜4ï¼šå¾®ä¿¡æ”¯ä»˜å‚æ•°ç­¾åé”™è¯¯

**ç°è±¡**ï¼š
```
æ”¯ä»˜å¤±è´¥ï¼šç­¾åé”™è¯¯
```

**åŸå› **ï¼š
- APIå¯†é’¥é…ç½®é”™è¯¯
- ç­¾åç®—æ³•é—®é¢˜

**è§£å†³**ï¼š
1. æ£€æŸ¥ `.env` ä¸­çš„ `WECHAT_PAY_KEY`
2. ç¡®è®¤å¯†é’¥æ­£ç¡®ï¼ˆä¸è¦æœ‰ç©ºæ ¼ï¼‰
3. é‡å¯åç«¯æœåŠ¡

---

## ğŸ§ª æµ‹è¯•æµç¨‹

### æµ‹è¯•1ï¼šæ¨¡æ‹Ÿæ”¯ä»˜ï¼ˆæ— å•†æˆ·å·ï¼‰

å¦‚æœæ²¡æœ‰é…ç½®å•†æˆ·å·ï¼Œä¼šä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜ï¼š

1. æ‰“å¼€å°ç¨‹åº
2. è¿›å…¥å……å€¼é¡µé¢
3. é€‰æ‹©é‡‘é¢ï¼ˆå¦‚100å…ƒï¼‰
4. ç‚¹å‡»"ç«‹å³å……å€¼"
5. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
   ```
   [å……å€¼] ä½¿ç”¨æ¨¡æ‹Ÿæ”¯ä»˜å‚æ•° - é‡‘é¢: 100.0å…ƒ (10000åˆ†)
   ```
6. å‰ç«¯ä¼šè°ƒèµ·å¾®ä¿¡æ”¯ä»˜ï¼ˆä½†æ˜¯æ¨¡æ‹Ÿçš„ï¼‰

### æµ‹è¯•2ï¼šçœŸå®æ”¯ä»˜ï¼ˆæœ‰å•†æˆ·å·ï¼‰

é…ç½®äº†å•†æˆ·å·åï¼š

1. æ‰“å¼€å°ç¨‹åº
2. è¿›å…¥å……å€¼é¡µé¢
3. é€‰æ‹©é‡‘é¢ï¼ˆå¦‚0.01å…ƒæµ‹è¯•ï¼‰
4. ç‚¹å‡»"ç«‹å³å……å€¼"
5. æŸ¥çœ‹åç«¯æ—¥å¿—ï¼š
   ```
   [å……å€¼] åˆ›å»ºå¾®ä¿¡æ”¯ä»˜è®¢å•:
     - å……å€¼å•å·: RC1697788800123456
     - å……å€¼é‡‘é¢: 0.01å…ƒ (1åˆ†)
     - ç”¨æˆ·OpenID: oXXXXXXXXXXXXXX
     - å•†æˆ·å·: 10026954
   [å……å€¼] ç»Ÿä¸€ä¸‹å•å‚æ•°: {..., 'total_fee': '1', ...}
   ```
6. å‰ç«¯è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
7. è¾“å…¥å¯†ç å®Œæˆæ”¯ä»˜

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨æµ‹è¯•å……å€¼å‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼ˆ`python -m app.main`ï¼‰
- [ ] ç”¨æˆ·å·²ä½¿ç”¨å¾®ä¿¡ç™»å½•ï¼ˆæœ‰openidï¼‰
- [ ] å……å€¼é‡‘é¢å¤§äº0.01å…ƒ
- [ ] `.env` æ–‡ä»¶é…ç½®æ­£ç¡®
- [ ] æ•°æ®åº“è¡¨ `recharge_records` å·²åˆ›å»º
- [ ] å‰ç«¯APIè¯·æ±‚æ­£å¸¸ï¼ˆæŸ¥çœ‹Networkï¼‰

---

## ğŸ’¡ è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹å®Œæ•´çš„åç«¯æ—¥å¿—

```bash
cd backend
python -m app.main 2>&1 | tee app.log
```

æ‰€æœ‰è¾“å‡ºä¼šåŒæ—¶æ˜¾ç¤ºåœ¨æ§åˆ¶å°å’Œä¿å­˜åˆ° `app.log`

### 2. å‰ç«¯è°ƒè¯•

åœ¨å……å€¼é¡µé¢çš„ `doRecharge` æ–¹æ³•ä¸­æ·»åŠ ï¼š
```javascript
async doRecharge() {
  console.log('=== å¼€å§‹å……å€¼ ===')
  console.log('å……å€¼é‡‘é¢:', this.finalAmount)
  console.log('æ”¯ä»˜æ–¹å¼:', this.paymentMethod)
  
  try {
    const res = await api.createRecharge({
      amount: this.finalAmount,
      payment_method: this.paymentMethod
    })
    console.log('åç«¯è¿”å›:', res.data)
    
    // ... è°ƒèµ·æ”¯ä»˜
  } catch (error) {
    console.error('å……å€¼å¤±è´¥:', error)
  }
}
```

### 3. ç½‘ç»œè¯·æ±‚æ£€æŸ¥

æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼š
1. åˆ‡æ¢åˆ° "Network" æ ‡ç­¾
2. ç‚¹å‡»å……å€¼
3. æŸ¥çœ‹ `/api/v1/recharge/create` è¯·æ±‚
4. æ£€æŸ¥ï¼š
   - Request Payload: `{"amount": 100, "payment_method": "wechat"}`
   - Response: è¿”å›çš„æ”¯ä»˜å‚æ•°

---

## ğŸ”§ å¿«é€Ÿä¿®å¤

å¦‚æœä»ç„¶æŠ¥é”™ï¼Œå°è¯•ï¼š

### æ–¹æ³•1ï¼šé‡å¯æœåŠ¡
```bash
# æ€æ‰ç°æœ‰è¿›ç¨‹
pkill -f "python -m app.main"

# é‡æ–°å¯åŠ¨
cd backend
python -m app.main
```

### æ–¹æ³•2ï¼šæ¸…é™¤æ•°æ®åº“é‡è¯•
```bash
mysql -u root -p123456 eceshi -e "TRUNCATE TABLE recharge_records;"
```

### æ–¹æ³•3ï¼šæ£€æŸ¥æ•°æ®ç±»å‹
```python
# åœ¨ recharge.py ä¸­æ·»åŠ æ‰“å°
print(f"å……å€¼é‡‘é¢ç±»å‹: {type(data.amount)}, å€¼: {data.amount}")
print(f"Decimalé‡‘é¢: {type(amount)}, å€¼: {amount}")
```

---

## ğŸ“ å¦‚æœé—®é¢˜ä»ç„¶å­˜åœ¨

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **åç«¯å®Œæ•´æ—¥å¿—**ï¼ˆä»ç‚¹å‡»å……å€¼å¼€å§‹ï¼‰
2. **å‰ç«¯æ§åˆ¶å°è¾“å‡º**
3. **Networkè¯·æ±‚è¯¦æƒ…**ï¼ˆåŒ…æ‹¬Requestå’ŒResponseï¼‰
4. **é”™è¯¯æˆªå›¾**

æ£€æŸ¥é‡ç‚¹ï¼š
- `total_fee` çš„å€¼æ˜¯å¤šå°‘ï¼Ÿ
- æ˜¯å¦çœŸçš„ä¼ é€’äº†è¿™ä¸ªå‚æ•°ï¼Ÿ
- å¾®ä¿¡æ”¯ä»˜è¿”å›çš„å…·ä½“é”™è¯¯ä¿¡æ¯ï¼Ÿ

---

**æ›´æ–°æ—¶é—´**ï¼š2025å¹´10æœˆ20æ—¥ 02:10  
**çŠ¶æ€**ï¼šâœ… å·²æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜
