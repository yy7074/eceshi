# 充值支付问题排查指南

## ❌ 问题描述

**错误信息**：支付 缺少参数 total_fee

---

## ✅ 已优化的内容

### 1. 添加了详细的日志输出
在 `wechatpay_service.py` 中添加了调试日志：
```python
print(f"[充值] 创建微信支付订单:")
print(f"  - 充值单号: {recharge.recharge_no}")
print(f"  - 充值金额: {recharge.amount}元 ({total_fee}分)")
print(f"  - 用户OpenID: {openid}")
print(f"  - 商户号: {self.mch_id}")
print(f"[充值] 统一下单参数: {params}")
```

### 2. 添加了金额验证
```python
# 确保金额大于0
if total_fee <= 0:
    raise ValueError(f"充值金额必须大于0，当前金额: {recharge.amount}")
```

### 3. 统一下单参数
确保 `total_fee` 参数正确传递：
```python
params = {
    'appid': self.app_id,
    'mch_id': self.mch_id,
    'nonce_str': self.generate_nonce_str(),
    'body': f'钱包充值',
    'out_trade_no': recharge.recharge_no,
    'total_fee': str(total_fee),  # ✅ 确保转为字符串
    'spbill_create_ip': '127.0.0.1',
    'notify_url': self.notify_url.replace('/payments/wechat/notify', '/recharge/wechat/notify'),
    'trade_type': 'JSAPI',
    'openid': openid
}
```

---

## 🔍 排查步骤

### 步骤1：查看后端日志

重启后端服务并查看控制台输出：

```bash
cd backend
python -m app.main
```

当你点击充值时，应该看到类似输出：
```
[充值] 创建微信支付订单:
  - 充值单号: RC1697788800123456
  - 充值金额: 100.0元 (10000分)
  - 用户OpenID: oXXXXXXXXXXXXXX
  - 商户号: 10026954
[充值] 统一下单参数: {'appid': 'wx2ef4744e64c7bc45', 'mch_id': '10026954', ...}
```

### 步骤2：检查充值金额

确认前端发送的充值金额正确：

**前端代码检查** (`recharge.vue`):
```javascript
async doRecharge() {
  // 确认 finalAmount 有值
  console.log('充值金额:', this.finalAmount)
  
  const res = await api.createRecharge({
    amount: this.finalAmount,  // ✅ 必须大于0
    payment_method: 'wechat'
  })
}
```

### 步骤3：检查用户登录状态

确认用户已使用微信登录（有openid）：

```bash
# 在后端日志中查找
[充值] 用户OpenID: oXXXXXXXXXXXXXX  # ✅ 应该有值
```

如果显示 `None` 或为空，说明用户未微信登录。

### 步骤4：检查商户号配置

查看 `.env` 文件：
```bash
cd backend
cat .env | grep WECHAT
```

应该看到：
```
WECHAT_APPID=wx2ef4744e64c7bc45
WECHAT_SECRET=80d47eff16201ebcd596c40d591d86dc
WECHAT_MCH_ID=10026954
WECHAT_PAY_KEY=fr54thyu78kijfsqv46mkl956edfg3ed
```

---

## 🐛 常见问题和解决方案

### 问题1：金额为0或空

**现象**：
```
[充值] 充值金额: 0.0元 (0分)
ValueError: 充值金额必须大于0
```

**原因**：
- 前端未选择金额
- 自定义金额输入为空

**解决**：
```javascript
// 前端添加验证
if (!this.finalAmount || this.finalAmount < 0.01) {
  uni.showToast({ title: '请输入充值金额', icon: 'none' })
  return
}
```

### 问题2：用户未微信登录

**现象**：
```
HTTPException: 请先使用微信登录
```

**原因**：
- 用户未使用微信登录
- current_user.wechat_openid 为 None

**解决**：
1. 引导用户使用微信登录
2. 检查微信登录功能是否正常

### 问题3：商户号或密钥未配置

**现象**：
```
[充值] 使用模拟支付参数
```

**说明**：
- 这是正常的（用于测试）
- 会返回模拟的支付参数
- 可以调起支付但不会真实扣款

**解决**：
- 开发测试：可以继续使用模拟模式
- 生产环境：配置真实的商户号和密钥

### 问题4：微信支付参数签名错误

**现象**：
```
支付失败：签名错误
```

**原因**：
- API密钥配置错误
- 签名算法问题

**解决**：
1. 检查 `.env` 中的 `WECHAT_PAY_KEY`
2. 确认密钥正确（不要有空格）
3. 重启后端服务

---

## 🧪 测试流程

### 测试1：模拟支付（无商户号）

如果没有配置商户号，会使用模拟支付：

1. 打开小程序
2. 进入充值页面
3. 选择金额（如100元）
4. 点击"立即充值"
5. 查看后端日志：
   ```
   [充值] 使用模拟支付参数 - 金额: 100.0元 (10000分)
   ```
6. 前端会调起微信支付（但是模拟的）

### 测试2：真实支付（有商户号）

配置了商户号后：

1. 打开小程序
2. 进入充值页面
3. 选择金额（如0.01元测试）
4. 点击"立即充值"
5. 查看后端日志：
   ```
   [充值] 创建微信支付订单:
     - 充值单号: RC1697788800123456
     - 充值金额: 0.01元 (1分)
     - 用户OpenID: oXXXXXXXXXXXXXX
     - 商户号: 10026954
   [充值] 统一下单参数: {..., 'total_fee': '1', ...}
   ```
6. 前端调起微信支付
7. 输入密码完成支付

---

## 📋 检查清单

在测试充值前，请确认：

- [ ] 后端服务正常运行（`python -m app.main`）
- [ ] 用户已使用微信登录（有openid）
- [ ] 充值金额大于0.01元
- [ ] `.env` 文件配置正确
- [ ] 数据库表 `recharge_records` 已创建
- [ ] 前端API请求正常（查看Network）

---

## 💡 调试技巧

### 1. 查看完整的后端日志

```bash
cd backend
python -m app.main 2>&1 | tee app.log
```

所有输出会同时显示在控制台和保存到 `app.log`

### 2. 前端调试

在充值页面的 `doRecharge` 方法中添加：
```javascript
async doRecharge() {
  console.log('=== 开始充值 ===')
  console.log('充值金额:', this.finalAmount)
  console.log('支付方式:', this.paymentMethod)
  
  try {
    const res = await api.createRecharge({
      amount: this.finalAmount,
      payment_method: this.paymentMethod
    })
    console.log('后端返回:', res.data)
    
    // ... 调起支付
  } catch (error) {
    console.error('充值失败:', error)
  }
}
```

### 3. 网络请求检查

打开微信开发者工具：
1. 切换到 "Network" 标签
2. 点击充值
3. 查看 `/api/v1/recharge/create` 请求
4. 检查：
   - Request Payload: `{"amount": 100, "payment_method": "wechat"}`
   - Response: 返回的支付参数

---

## 🔧 快速修复

如果仍然报错，尝试：

### 方法1：重启服务
```bash
# 杀掉现有进程
pkill -f "python -m app.main"

# 重新启动
cd backend
python -m app.main
```

### 方法2：清除数据库重试
```bash
mysql -u root -p123456 eceshi -e "TRUNCATE TABLE recharge_records;"
```

### 方法3：检查数据类型
```python
# 在 recharge.py 中添加打印
print(f"充值金额类型: {type(data.amount)}, 值: {data.amount}")
print(f"Decimal金额: {type(amount)}, 值: {amount}")
```

---

## 📞 如果问题仍然存在

请提供以下信息：

1. **后端完整日志**（从点击充值开始）
2. **前端控制台输出**
3. **Network请求详情**（包括Request和Response）
4. **错误截图**

检查重点：
- `total_fee` 的值是多少？
- 是否真的传递了这个参数？
- 微信支付返回的具体错误信息？

---

**更新时间**：2025年10月20日 02:10  
**状态**：✅ 已添加详细日志，便于排查问题
