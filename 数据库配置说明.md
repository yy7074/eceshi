# 数据库配置说明

## 当前状态

### ✅ 已完成
- 数据库连接代码
- 数据库模型定义
- MySQL已安装：`/opt/homebrew/bin/mysql`

### ⚠️ 需要配置
1. 配置环境变量（`.env`）
2. 创建数据库和表
3. 测试数据库连接

---

## 🔧 快速配置步骤

### 步骤1: 配置环境变量

```bash
cd backend

# 创建 .env 文件
cat > .env << 'EOF'
# 应用配置
APP_NAME=科研检测服务平台
APP_VERSION=1.0.0
DEBUG=True
SECRET_KEY=dev-secret-key-2024

# 服务器配置
HOST=0.0.0.0
PORT=8000

# 数据库配置（请修改密码）
DATABASE_URL=mysql+pymysql://root:YOUR_PASSWORD@localhost:3306/eceshi?charset=utf8mb4
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20

# Redis配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

# JWT配置
JWT_SECRET_KEY=jwt-secret-key-2024
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=1440

# CORS配置
CORS_ORIGINS=http://localhost:3000,http://localhost:8080,http://localhost:8081
EOF

# ⚠️ 重要：修改 DATABASE_URL 中的密码
# 将 YOUR_PASSWORD 替换为您的MySQL密码
nano .env  # 或使用其他编辑器
```

### 步骤2: 初始化数据库

```bash
cd backend

# 安装依赖（如果还未安装）
pip install -r requirements.txt

# 运行数据库初始化脚本
python init_db.py
```

**成功输出示例**：
```
🚀 开始初始化数据库...

📦 步骤1: 创建数据库
✅ 数据库 'eceshi' 创建成功（或已存在）

📦 步骤2: 创建数据库表
✅ 数据库表创建成功

📋 已创建的表：
  - users
  - user_certification

✅ 数据库初始化完成！
```

### 步骤3: 启动后端服务

```bash
# 启动服务
uvicorn app.main:app --reload

# 访问API文档
# http://localhost:8000/api/docs
```

---

## 📋 数据库表结构

### 已创建的表

#### 1. users（用户表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| phone | VARCHAR(20) | 手机号（唯一） |
| password | VARCHAR(255) | 密码哈希 |
| nickname | VARCHAR(50) | 昵称 |
| avatar | VARCHAR(255) | 头像URL |
| is_certified | BOOLEAN | 是否实名认证 |
| membership_level | ENUM | 会员等级 |
| credit_limit | DECIMAL(10,2) | 信用额度 |
| prepaid_balance | DECIMAL(10,2) | 预付余额 |
| points_balance | INT | 积分余额 |
| total_spent | DECIMAL(10,2) | 累计消费 |
| status | ENUM | 用户状态 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### 2. user_certification（用户认证表）
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INT | 主键 |
| user_id | INT | 用户ID |
| enrollment_year | VARCHAR(10) | 入学年份 |
| university | VARCHAR(100) | 高校 |
| department | VARCHAR(100) | 院系 |
| supervisor_name | VARCHAR(50) | 导师姓名 |
| status | VARCHAR(20) | 审核状态 |
| created_at | DATETIME | 创建时间 |
| certified_at | DATETIME | 认证时间 |

---

## 🔍 数据库检查命令

### 检查数据库
```bash
mysql -u root -p
```

```sql
-- 查看所有数据库
SHOW DATABASES;

-- 使用eceshi数据库
USE eceshi;

-- 查看所有表
SHOW TABLES;

-- 查看users表结构
DESCRIBE users;

-- 查看用户数据
SELECT id, phone, nickname, is_certified, membership_level, created_at FROM users;
```

---

## ❌ 常见问题

### Q1: 数据库初始化失败
**错误**: `Access denied for user 'root'@'localhost'`

**解决方案**:
```bash
# 检查MySQL密码
mysql -u root -p

# 如果忘记密码，重置MySQL密码
# Mac系统：
brew services stop mysql
mysqld_safe --skip-grant-tables &
mysql -u root
```
```sql
ALTER USER 'root'@'localhost' IDENTIFIED BY 'new_password';
FLUSH PRIVILEGES;
```

### Q2: 无法连接到MySQL
**检查MySQL服务状态**:
```bash
# Mac (Homebrew)
brew services list
brew services start mysql

# 检查端口
lsof -i :3306
```

### Q3: 字符编码问题
确保数据库和表都使用 `utf8mb4`:
```sql
ALTER DATABASE eceshi CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

---

## 🧪 测试数据库连接

创建测试脚本 `test_db.py`:
```python
from app.core.database import engine
from sqlalchemy import text

try:
    with engine.connect() as conn:
        result = conn.execute(text("SELECT 1"))
        print("✅ 数据库连接成功！")
        
        result = conn.execute(text("SELECT DATABASE()"))
        db_name = result.scalar()
        print(f"📦 当前数据库：{db_name}")
        
        result = conn.execute(text("SHOW TABLES"))
        tables = [row[0] for row in result]
        print(f"📋 数据库表：{tables}")
except Exception as e:
    print(f"❌ 数据库连接失败：{e}")
```

运行测试：
```bash
cd backend
python test_db.py
```

---

## 📊 后续数据库表（待创建）

根据开发计划，还需要创建以下表：

### 第二迭代
- orders（订单表）
- order_samples（订单样品表）
- order_fees（订单费用表）
- payments（支付记录表）

### 第三迭代
- laboratories（实验室表）
- equipment（设备表）
- test_data（测试数据表）
- test_reports（测试报告表）

### 更多表
详见：[开发计划.md](../开发计划.md) 第三章 数据库设计

---

## ✅ 检查清单

配置完成后，请确认：

- [ ] MySQL服务已启动
- [ ] `.env` 文件已创建并配置正确
- [ ] 数据库 `eceshi` 已创建
- [ ] 表 `users` 和 `user_certification` 已创建
- [ ] 后端服务可以正常启动
- [ ] API文档可以访问（http://localhost:8000/api/docs）

---

**完成以上步骤后，数据库就配置好了！** 🎉

