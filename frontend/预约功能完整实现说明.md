# 预约功能完整实现说明

## ✅ 已实现的功能

### 1. **三步预约流程**

#### 步骤1：填写样品信息
- ✅ 样品数量控制（+-按钮）
- ✅ 样品编号（自动显示）
- ✅ 样品名称输入
- ✅ 样品成分输入
- ✅ 样品状态选择（粉末、块状/薄膜、溶液、气体、其它）
- ✅ 危险性选择（普通、易燃、氧化性、放射性、腐蚀性、有毒、无）
- ✅ 存放要求选择（冷藏、干燥、避光、真空、其它、无）
- ✅ 备注填写
- ✅ 表单验证（样品名称、样品状态必填）

#### 步骤2：完善配送信息
- ✅ 收货地址选择/添加
  - 显示已选地址的完整信息（姓名、电话、地址）
  - 点击可更换地址
  - 无地址时显示添加地址入口
- ✅ 寄送方式选择
  - 快递（3-5个工作日）
  - 自送（自行送达实验室）
- ✅ 送达时间选择（日期选择器）
- ✅ 配送备注输入（选填）
- ✅ 表单验证（收货地址、送达日期必选）

#### 步骤3：提交文档和支付
- ✅ 订单信息展示
  - 项目名称
  - 样品数量
  - 寄送方式
  - 收货地址
- ✅ 附件上传功能
  - 支持多图片上传
  - 文件列表展示
  - 可删除已上传文件
- ✅ 费用明细展示
  - 测试费用
  - 样品数量
  - 配送费用
  - 总计费用（动态计算）
- ✅ 支付方式选择
  - 微信支付（带图标）
  - 支付宝支付（带图标）
- ✅ 订单提交流程
  - 文件上传到服务器
  - 创建订单
  - 调起支付
  - 支付成功跳转订单详情

### 2. **附加功能**

#### 草稿保存
- ✅ 自动保存表单数据到本地存储
- ✅ 再次进入时恢复草稿
- ✅ 手动"存为草稿"按钮

#### 步骤导航
- ✅ 顶部步骤指示器（01/02/03）
- ✅ 当前步骤高亮显示
- ✅ 已完成步骤标记
- ✅ "上一步"按钮（步骤2和3显示）
- ✅ "下一步"/"提交订单"按钮

#### 底部操作栏
- ✅ 实时显示费用合计
- ✅ 三个操作按钮
  - 上一步（仅步骤2/3显示）
  - 存为草稿
  - 下一步/提交订单

## 📝 使用流程

### 从项目列表进入预约
```javascript
// 在项目卡片上点击"立即预约"
goBooking(item) {
  uni.navigateTo({
    url: `/pagesA/booking/booking?projectId=${item.id}&projectName=${encodeURIComponent(item.name)}`
  })
}
```

### 页面加载
1. 获取项目ID和项目名称
2. 加载项目详情（价格等信息）
3. 尝试恢复草稿数据

### 步骤1：填写样品信息
1. 用户填写样品相关信息
2. 点击"下一步"进行验证
3. 验证通过后进入步骤2

### 步骤2：完善配送信息
1. 选择或添加收货地址
2. 选择寄送方式
3. 选择送达日期
4. 填写配送备注（可选）
5. 点击"下一步"进行验证
6. 验证通过后进入步骤3

### 步骤3：提交文档和支付
1. 查看订单信息汇总
2. 上传附件（可选）
3. 查看费用明细
4. 选择支付方式
5. 点击"提交订单"
6. 系统自动：
   - 上传所有附件到服务器
   - 创建订单
   - 调起微信支付/支付宝支付
7. 支付成功后跳转订单详情页

## 🔧 技术实现

### 数据结构
```javascript
formData: {
  // 步骤1
  sampleCount: 1,           // 样品数量
  sampleName: '',           // 样品名称
  sampleComposition: '',    // 样品成分
  sampleState: '',          // 样品状态
  dangerType: '',           // 危险性
  storageRequirement: '',   // 存放要求
  remark: '',               // 备注
  
  // 步骤2
  addressId: null,          // 地址ID
  deliveryMethod: 'express',// 寄送方式
  deliveryDate: '',         // 送达日期
  deliveryRemark: '',       // 配送备注
  
  // 步骤3
  files: [],                // 附件列表
  paymentMethod: 'wechat'   // 支付方式
}
```

### API接口调用

#### 1. 创建订单
```javascript
const orderData = {
  project_id: this.projectId,
  sample_count: this.formData.sampleCount,
  sample_name: this.formData.sampleName,
  // ... 其他字段
  total_amount: this.totalPrice
}

const res = await api.createOrder(orderData)
```

#### 2. 上传文件
```javascript
uni.uploadFile({
  url: 'https://catdog.dachaonet.com/api/v1/upload/image',
  filePath: filePath,
  name: 'file',
  header: {
    'Authorization': `Bearer ${token}`
  },
  success: (res) => {
    const data = JSON.parse(res.data)
    // 获取上传后的URL
  }
})
```

#### 3. 创建支付
```javascript
const res = await api.createPayment({
  order_id: orderId,
  payment_method: 'wechat'
})

// 调起微信支付
uni.requestPayment({
  provider: 'wxpay',
  timeStamp: res.data.timeStamp,
  nonceStr: res.data.nonceStr,
  package: res.data.package,
  signType: res.data.signType,
  paySign: res.data.paySign,
  success: () => {
    // 支付成功
  }
})
```

### 草稿功能
```javascript
// 保存草稿
saveDraft() {
  const draft = {
    projectId: this.projectId,
    currentStep: this.currentStep,
    formData: this.formData,
    selectedAddress: this.selectedAddress
  }
  uni.setStorageSync('booking_draft', JSON.stringify(draft))
}

// 加载草稿
loadDraft() {
  const draft = uni.getStorageSync('booking_draft')
  if (draft) {
    const data = JSON.parse(draft)
    if (data.projectId == this.projectId) {
      this.currentStep = data.currentStep
      this.formData = data.formData
      this.selectedAddress = data.selectedAddress
    }
  }
}
```

## 📱 页面路径
- 预约页面：`/pagesA/booking/booking`
- 地址管理：`/pagesA/address/address`
- 订单详情：`/pagesA/order-detail/order-detail`

## 🎨 UI特性
- ✅ 步骤指示器清晰
- ✅ 表单项分组明确
- ✅ 按钮状态区分明显
- ✅ 费用实时计算显示
- ✅ 响应式布局适配
- ✅ 错误提示友好

## 🔍 验证规则

### 步骤1验证
- 样品名称：必填
- 样品状态：必选

### 步骤2验证
- 收货地址：必选
- 送达日期：必选

### 步骤3验证
- 支付方式：必选（默认微信支付）

## 📦 文件结构
```
frontend/
├── pagesA/
│   └── booking/
│       └── booking.vue          # 预约页面（完整三步流程）
├── static/
│   ├── wechat-pay.svg           # 微信支付图标
│   └── alipay.svg               # 支付宝图标
└── utils/
    └── api.js                    # API接口定义
```

## 🚀 测试步骤

1. **在首页或分类页点击项目的"立即预约"按钮**
2. **步骤1：填写样品信息**
   - 调整样品数量
   - 填写样品名称
   - 选择样品状态
   - 点击"下一步"
3. **步骤2：完善配送信息**
   - 选择收货地址
   - 选择寄送方式
   - 选择送达日期
   - 点击"下一步"
4. **步骤3：提交文档和支付**
   - 查看订单信息
   - 上传附件（可选）
   - 查看费用明细
   - 选择支付方式
   - 点击"提交订单"
5. **支付流程**
   - 调起微信支付
   - 完成支付
   - 跳转订单详情

## ⚠️ 注意事项

1. 需要先登录才能使用预约功能
2. 收货地址需要先在地址管理中添加
3. 文件上传需要有效的token
4. 支付功能需要后端支付接口支持
5. 草稿数据存储在本地，清除缓存会丢失

## 🎯 后续可优化

- [ ] 添加实时价格计算（根据样品数量动态更新）
- [ ] 优惠券/积分抵扣功能
- [ ] 订单预览弹窗
- [ ] 支付结果页面
- [ ] 订单状态实时推送
- [ ] 更多支付方式（银行卡、余额等）

