# 钱包充值测试指南

## ✅ 已修复的问题

1. ✅ 修复了 `Response` 导入路径错误
2. ✅ 修复了 `getUserBalance` 方法名错误（改为 `getBalance`）
3. ✅ 数据库表 `recharge_records` 已存在

---

## 🧪 测试步骤

### 1. 确认后端服务运行
```bash
cd backend
python -m app.main

# 确认服务运行在 http://localhost:3000
# 查看日志确认没有错误
```

### 2. 测试API接口

#### 测试充值赠送规则
```bash
curl http://localhost:3000/api/v1/recharge/bonus/rules
```

期望返回：
```json
{
  "code": 200,
  "data": {
    "rules": [
      {
        "min_amount": 0,
        "max_amount": 99.99,
        "bonus_rate": 0,
        "description": "100元以下不赠送"
      },
      ...
    ]
  }
}
```

#### 测试账户余额查询（需要登录）
```bash
# 先登录获取token
curl -X POST http://localhost:3000/api/v1/auth/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code":"test"}'

# 使用token查询余额
curl http://localhost:3000/api/v1/users/balance \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 3. 测试小程序前端

#### 步骤1：打开微信开发者工具
- 导入项目：`/Users/yy/Documents/GitHub/eceshi/frontend`
- 确认AppID：`wx2ef4744e64c7bc45`

#### 步骤2：登录小程序
- 使用微信登录功能
- 确认登录成功

#### 步骤3：进入充值页面
- 点击底部 "我的" 标签
- 点击 "个人预付" 卡片（显示余额的那个）
- 应该跳转到充值页面

#### 步骤4：测试充值功能
- 查看余额是否正确显示
- 选择一个快捷金额（如100元）
- 查看赠送提示是否显示："充100元，赠送5元，到账105元"
- 点击"立即充值"
- 查看是否调起微信支付

---

## 🐛 常见问题排查

### 问题1：页面无法打开
**检查**：
```bash
# 查看pages.json是否正确配置
grep -A 5 "recharge/recharge" frontend/pages.json
```

**解决**：确认路由配置正确

### 问题2：余额不显示
**检查**：
```bash
# 查看API是否正常
curl http://localhost:3000/api/v1/users/balance \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**解决**：
- 确认用户已登录
- 确认token有效
- 查看浏览器控制台错误

### 问题3：充值按钮无响应
**检查**：
- 打开微信开发者工具控制台
- 查看是否有JavaScript错误
- 查看网络请求是否发送

**解决**：
- 确认用户已登录（微信登录）
- 确认选择了充值金额
- 查看控制台具体错误信息

### 问题4：创建充值订单失败
**可能原因**：
- 用户未微信登录（缺少openid）
- 充值金额不合法
- 后端服务异常

**检查后端日志**：
```bash
# 查看最近的错误日志
tail -f backend/logs/app.log
# 或直接看控制台输出
```

### 问题5：微信支付调起失败
**检查**：
- 是否在真机上测试（微信支付不支持模拟器）
- 是否配置了商户号和密钥
- 是否使用了正确的AppID

---

## 📱 测试场景

### 场景1：快捷金额充值
1. 选择100元
2. 确认显示"赠送5元"
3. 点击充值
4. 完成支付
5. 查看余额是否增加105元

### 场景2：自定义金额充值
1. 输入自定义金额（如520元）
2. 确认显示"赠送52元"
3. 点击充值
4. 完成支付
5. 查看余额是否增加572元

### 场景3：查看充值记录
1. 点击"充值记录"
2. 查看记录列表
3. 点击某条记录查看详情

---

## 🔍 调试技巧

### 1. 前端调试
```javascript
// 在recharge.vue的methods中添加调试信息
async loadBalance() {
  try {
    console.log('开始加载余额...')
    const res = await api.getBalance()
    console.log('余额数据:', res.data)
    this.balance = res.data.prepaid_balance || 0
    console.log('当前余额:', this.balance)
  } catch (error) {
    console.error('加载余额失败', error)
  }
}
```

### 2. 后端调试
```python
# 在recharge.py的create_recharge方法中添加调试信息
print(f"创建充值订单: 用户ID={current_user.id}, 金额={amount}")
print(f"计算赠送: 充值{amount}元, 赠送{bonus_amount}元")
print(f"创建支付参数...")
```

### 3. 网络请求调试
- 打开微信开发者工具
- 切换到 "Network" 标签
- 查看所有API请求
- 检查请求参数和响应数据

---

## ✅ 测试检查清单

- [ ] 后端服务正常运行
- [ ] 数据库表已创建
- [ ] 微信登录功能正常
- [ ] 充值页面可以打开
- [ ] 余额正确显示
- [ ] 快捷金额可以选择
- [ ] 自定义金额可以输入
- [ ] 赠送金额正确计算
- [ ] 充值按钮可以点击
- [ ] 微信支付可以调起
- [ ] 充值记录可以查看

---

## 📞 如遇问题

请提供以下信息：
1. 具体的错误信息（截图）
2. 后端日志输出
3. 前端控制台错误
4. 网络请求详情

---

**更新时间**：2025年10月20日 01:50
**状态**：✅ 已修复导入错误，可以正常测试
