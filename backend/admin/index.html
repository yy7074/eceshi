<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>科研检测服务平台 - 后台管理</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-plus"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-plus/dist/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB',
                'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .login-box {
            width: 450px;
            padding: 40px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .admin-layout {
            height: 100vh;
        }
        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: #001529;
            color: white;
            height: 60px;
        }
        .admin-header h2 {
            margin: 0;
            font-size: 18px;
        }
        .admin-container {
            height: calc(100vh - 60px);
        }
        .admin-aside {
            background: #001529;
            color: white;
        }
        .admin-aside .el-menu {
            border-right: none;
            background-color: #001529;
        }
        .admin-main {
            background: #f0f2f5;
            overflow-y: auto;
            padding: 20px;
        }
        .page-header {
            background: white;
            padding: 16px 24px;
            margin-bottom: 16px;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
        }
        .page-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #262626;
        }
        .content-card {
            background: white;
            border-radius: 4px;
            padding: 24px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.03);
            margin-bottom: 16px;
        }
        .image-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        .image-item {
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .image-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .image-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .image-item-footer {
            padding: 8px;
            background: #f5f5f5;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- 登录页面 -->
        <div v-if="!token" class="login-container">
            <div class="login-box">
                <h2 style="text-align: center; margin-bottom: 30px;">🔬 后台管理登录</h2>
                
                <el-tabs v-model="loginType">
                    <!-- 管理员登录 -->
                    <el-tab-pane label="管理员登录" name="admin">
                        <el-form :model="adminLoginForm" @submit.prevent="handleAdminLogin">
                            <el-form-item label="用户名">
                                <el-input v-model="adminLoginForm.username" placeholder="请输入用户名"></el-input>
                            </el-form-item>
                            <el-form-item label="密码">
                                <el-input 
                                    v-model="adminLoginForm.password" 
                                    type="password" 
                                    placeholder="请输入密码"
                                    show-password
                                    @keyup.enter="handleAdminLogin"></el-input>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="handleAdminLogin" style="width: 100%;" :loading="loading">
                                    登录
                                </el-button>
                            </el-form-item>
                            <el-alert title="默认账号: admin / 123456" type="info" :closable="false" show-icon />
                        </el-form>
                    </el-tab-pane>
                    
                    <!-- 短信登录 -->
                    <el-tab-pane label="短信登录" name="sms">
                        <el-form :model="loginForm" @submit.prevent="handleLogin">
                            <el-form-item label="手机号">
                                <el-input v-model="loginForm.phone" placeholder="请输入手机号"></el-input>
                            </el-form-item>
                            <el-form-item label="验证码">
                                <el-input v-model="loginForm.sms_code" placeholder="请输入验证码">
                                    <template #append>
                                        <el-button @click="sendSms" :disabled="countdown > 0">
                                            {{ countdown > 0 ? `${countdown}秒后重试` : '获取验证码' }}
                                        </el-button>
                                    </template>
                                </el-input>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="handleLogin" style="width: 100%;" :loading="loading">
                                    登录
                                </el-button>
                            </el-form-item>
                        </el-form>
                    </el-tab-pane>
                </el-tabs>
            </div>
        </div>

        <!-- 后台管理主界面 -->
        <el-container v-else class="admin-layout">
            <!-- 顶部 -->
            <el-header class="admin-header" height="60px">
                <div>
                    <h2>🔬 科研检测服务平台 - 后台管理</h2>
                </div>
                <div>
                    <el-dropdown>
                        <span style="cursor: pointer; color: white;">
                            {{ userInfo.nickname || '管理员' }}
                            <el-icon style="margin-left: 5px;"><arrow-down /></el-icon>
                        </span>
                        <template #dropdown>
                            <el-dropdown-menu>
                                <el-dropdown-item @click="logout">
                                    <el-icon><switch-button /></el-icon>
                                    退出登录
                                </el-dropdown-item>
                            </el-dropdown-menu>
                        </template>
                    </el-dropdown>
                </div>
            </el-header>

            <!-- 主体 -->
            <el-container class="admin-container">
                <!-- 左侧菜单 -->
                <el-aside class="admin-aside" width="200px">
                    <el-menu
                        :default-active="activeMenu"
                        background-color="#001529"
                        text-color="#fff"
                        active-text-color="#409EFF"
                        @select="handleMenuSelect">
                        <el-menu-item index="users">
                            <el-icon><user /></el-icon>
                            <span>用户管理</span>
                        </el-menu-item>
                        <el-menu-item index="projects">
                            <el-icon><picture /></el-icon>
                            <span>项目管理</span>
                        </el-menu-item>
                        <el-menu-item index="orders">
                            <el-icon><document /></el-icon>
                            <span>订单管理</span>
                        </el-menu-item>
                        <el-menu-item index="settings">
                            <el-icon><setting /></el-icon>
                            <span>系统设置</span>
                        </el-menu-item>
                    </el-menu>
                </el-aside>

                <!-- 右侧内容 -->
                <el-main class="admin-main">
                    <!-- 用户管理 -->
                    <div v-show="activeMenu === 'users'">
                        <div class="page-header">
                            <h3>👥 用户管理</h3>
                        </div>

                        <div class="content-card">
                            <div style="margin-bottom: 20px;">
                                <el-input 
                                    v-model="userSearch" 
                                    placeholder="搜索手机号或昵称"
                                    style="width: 300px; margin-right: 10px;"
                                    @change="loadUsers">
                                    <template #prefix>
                                        <el-icon><search /></el-icon>
                                    </template>
                                </el-input>
                                <el-button type="primary" @click="loadUsers">搜索</el-button>
                                <el-button @click="userSearch=''; loadUsers()">重置</el-button>
                            </div>

                            <el-table :data="users" style="width: 100%" v-loading="usersLoading">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column label="头像" width="80">
                                    <template #default="scope">
                                        <el-avatar 
                                            :size="40" 
                                            :src="scope.row.avatar ? baseUrl + scope.row.avatar : undefined">
                                            {{ scope.row.nickname ? scope.row.nickname[0] : '?' }}
                                        </el-avatar>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="nickname" label="昵称" width="120"></el-table-column>
                                <el-table-column prop="phone" label="手机号" width="130">
                                    <template #default="scope">
                                        {{ scope.row.phone || '未绑定' }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="登录方式" width="100">
                                    <template #default="scope">
                                        <el-tag v-if="scope.row.wechat_openid" type="success" size="small">微信</el-tag>
                                        <el-tag v-if="scope.row.phone" type="info" size="small">手机</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="credit_limit" label="信用额度" width="100">
                                    <template #default="scope">
                                        ¥{{ scope.row.credit_limit }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="total_spent" label="累计消费" width="100">
                                    <template #default="scope">
                                        ¥{{ scope.row.total_spent }}
                                    </template>
                                </el-table-column>
                                <el-table-column prop="total_orders" label="订单数" width="80"></el-table-column>
                                <el-table-column label="状态" width="80">
                                    <template #default="scope">
                                        <el-tag 
                                            :type="scope.row.status === 'active' ? 'success' : 'danger'" 
                                            size="small">
                                            {{ getStatusText(scope.row.status) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="created_at" label="注册时间" width="170">
                                    <template #default="scope">
                                        {{ formatDate(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="scope">
                                        <el-button type="primary" size="small" @click="viewUser(scope.row)">
                                            查看
                                        </el-button>
                                        <el-button 
                                            v-if="scope.row.status === 'active'"
                                            type="danger" 
                                            size="small" 
                                            @click="updateUserStatus(scope.row.id, 'banned')">
                                            禁用
                                        </el-button>
                                        <el-button 
                                            v-else
                                            type="success" 
                                            size="small" 
                                            @click="updateUserStatus(scope.row.id, 'active')">
                                            激活
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <el-pagination
                                v-model:current-page="userPage"
                                v-model:page-size="userPageSize"
                                :page-sizes="[10, 20, 50, 100]"
                                :total="userTotal"
                                layout="total, sizes, prev, pager, next, jumper"
                                @size-change="loadUsers"
                                @current-change="loadUsers"
                                style="margin-top: 20px; justify-content: center;">
                            </el-pagination>

                            <!-- 用户详情对话框 -->
                            <el-dialog v-model="userDialogVisible" title="用户详情" width="700px">
                                <div v-if="selectedUser" style="display: flex; gap: 20px;">
                                    <!-- 左侧头像 -->
                                    <div style="flex-shrink: 0; text-align: center;">
                                        <el-avatar 
                                            :size="120" 
                                            :src="selectedUser.avatar ? baseUrl + selectedUser.avatar : undefined"
                                            style="margin-bottom: 12px;">
                                            {{ selectedUser.nickname ? selectedUser.nickname[0] : '?' }}
                                        </el-avatar>
                                        <div>
                                            <el-button size="small" @click="avatarUploadVisible = true; currentEditUserId = selectedUser.id">
                                                修改头像
                                            </el-button>
                                        </div>
                                    </div>
                                    
                                    <!-- 右侧详情 -->
                                    <div style="flex: 1;">
                                        <el-descriptions :column="2" border>
                                            <el-descriptions-item label="用户ID">{{ selectedUser.id }}</el-descriptions-item>
                                            <el-descriptions-item label="昵称">{{ selectedUser.nickname }}</el-descriptions-item>
                                            <el-descriptions-item label="手机号">{{ selectedUser.phone || '未绑定' }}</el-descriptions-item>
                                            <el-descriptions-item label="邮箱">{{ selectedUser.email || '未填写' }}</el-descriptions-item>
                                            <el-descriptions-item label="微信OpenID" :span="2">
                                                {{ selectedUser.wechat_openid || '未绑定' }}
                                            </el-descriptions-item>
                                            <el-descriptions-item label="实名认证">
                                                <el-tag :type="selectedUser.is_certified ? 'success' : 'info'" size="small">
                                                    {{ selectedUser.is_certified ? '已认证' : '未认证' }}
                                                </el-tag>
                                            </el-descriptions-item>
                                            <el-descriptions-item label="会员等级">
                                                {{ getMemberLevelText(selectedUser.membership_level) }}
                                            </el-descriptions-item>
                                            <el-descriptions-item label="信用额度">¥{{ selectedUser.credit_limit }}</el-descriptions-item>
                                            <el-descriptions-item label="已用额度">¥{{ selectedUser.used_credit }}</el-descriptions-item>
                                            <el-descriptions-item label="预付余额">¥{{ selectedUser.prepaid_balance }}</el-descriptions-item>
                                            <el-descriptions-item label="积分余额">{{ selectedUser.points_balance }}</el-descriptions-item>
                                            <el-descriptions-item label="累计消费">¥{{ selectedUser.total_spent }}</el-descriptions-item>
                                            <el-descriptions-item label="订单总数">{{ selectedUser.total_orders }}</el-descriptions-item>
                                            <el-descriptions-item label="账户状态">
                                                <el-tag :type="selectedUser.status === 'active' ? 'success' : 'danger'" size="small">
                                                    {{ getStatusText(selectedUser.status) }}
                                                </el-tag>
                                            </el-descriptions-item>
                                            <el-descriptions-item label="注册时间">{{ formatDate(selectedUser.created_at) }}</el-descriptions-item>
                                            <el-descriptions-item label="最后登录">{{ formatDate(selectedUser.last_login_at) }}</el-descriptions-item>
                                        </el-descriptions>
                                    </div>
                                </div>
                            </el-dialog>

                            <!-- 修改头像对话框 -->
                            <el-dialog v-model="avatarUploadVisible" title="修改用户头像" width="400px">
                                <el-upload
                                    drag
                                    :action="uploadUrl"
                                    :headers="uploadHeaders"
                                    :on-success="handleAvatarUploadSuccess"
                                    :before-upload="beforeUpload"
                                    accept="image/*">
                                    <el-icon class="el-icon--upload"><upload-filled /></el-icon>
                                    <div class="el-upload__text">
                                        将头像拖到此处，或<em>点击上传</em>
                                    </div>
                                    <template #tip>
                                        <div class="el-upload__tip">
                                            建议尺寸 200x200px，支持 jpg/png 格式
                                        </div>
                                    </template>
                                </el-upload>
                            </el-dialog>
                        </div>
                    </div>

                    <!-- 项目管理 -->
                    <div v-show="activeMenu === 'projects'">
                        <div class="page-header">
                            <h3>📸 项目管理</h3>
                        </div>
                        
                        <div class="content-card">
                            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <el-input 
                                        v-model="projectSearch" 
                                        placeholder="搜索项目名称或编号"
                                        style="width: 300px; margin-right: 10px;"
                                        @change="loadProjects">
                                        <template #prefix>
                                            <el-icon><search /></el-icon>
                                        </template>
                                    </el-input>
                                    <el-select v-model="projectCategoryFilter" placeholder="选择分类" style="width: 150px; margin-right: 10px;" @change="loadProjects" clearable>
                                        <el-option v-for="cat in categories" :key="cat.id" :label="cat.name" :value="cat.id"></el-option>
                                    </el-select>
                                    <el-button type="primary" @click="loadProjects">搜索</el-button>
                                    <el-button @click="projectSearch=''; projectCategoryFilter=null; loadProjects()">重置</el-button>
                                </div>
                                <el-button type="primary" @click="showProjectDialog()">
                                    <el-icon><plus /></el-icon> 添加项目
                                </el-button>
                            </div>

                            <el-table :data="projects" style="width: 100%" v-loading="projectsLoading">
                                <el-table-column prop="id" label="ID" width="60"></el-table-column>
                                <el-table-column label="封面" width="80">
                                    <template #default="scope">
                                        <el-image 
                                            v-if="scope.row.cover_image"
                                            :src="scope.row.cover_image" 
                                            style="width: 60px; height: 60px; border-radius: 4px;"
                                            fit="cover"
                                            :preview-src-list="[scope.row.cover_image]">
                                        </el-image>
                                        <span v-else style="color: #ccc;">无</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="project_no" label="编号" width="100"></el-table-column>
                                <el-table-column prop="name" label="项目名称" width="200" show-overflow-tooltip></el-table-column>
                                <el-table-column prop="category_name" label="分类" width="120"></el-table-column>
                                <el-table-column label="价格" width="120">
                                    <template #default="scope">
                                        <div>¥{{ scope.row.current_price }}</div>
                                        <div style="font-size: 12px; color: #999; text-decoration: line-through;">¥{{ scope.row.original_price }}</div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="标签" width="120">
                                    <template #default="scope">
                                        <el-tag v-if="scope.row.is_hot" type="danger" size="small" style="margin-right: 5px;">热门</el-tag>
                                        <el-tag v-if="scope.row.is_recommended" type="warning" size="small">推荐</el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="统计" width="100">
                                    <template #default="scope">
                                        <div style="font-size: 12px;">浏览: {{ scope.row.view_count }}</div>
                                        <div style="font-size: 12px;">预约: {{ scope.row.booking_count }}</div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="状态" width="80">
                                    <template #default="scope">
                                        <el-tag :type="scope.row.status === 'active' ? 'success' : 'info'" size="small">
                                            {{ scope.row.status === 'active' ? '上架' : '下架' }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="240" fixed="right">
                                    <template #default="scope">
                                        <el-button type="primary" size="small" @click="showProjectDialog(scope.row)">编辑</el-button>
                                        <el-button 
                                            v-if="scope.row.status === 'active'"
                                            type="warning" 
                                            size="small" 
                                            @click="updateProjectStatus(scope.row.id, 'inactive')">
                                            下架
                                        </el-button>
                                        <el-button 
                                            v-else
                                            type="success" 
                                            size="small" 
                                            @click="updateProjectStatus(scope.row.id, 'active')">
                                            上架
                                        </el-button>
                                        <el-button type="danger" size="small" @click="deleteProject(scope.row.id)">删除</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <el-pagination
                                v-model:current-page="projectPage"
                                v-model:page-size="projectPageSize"
                                :page-sizes="[10, 20, 50]"
                                :total="projectTotal"
                                layout="total, sizes, prev, pager, next, jumper"
                                @size-change="loadProjects"
                                @current-change="loadProjects"
                                style="margin-top: 20px; justify-content: center;">
                            </el-pagination>

                            <!-- 添加/编辑项目对话框 -->
                            <el-dialog 
                                v-model="projectDialogVisible" 
                                :title="projectForm.id ? '编辑项目' : '添加项目'" 
                                width="600px">
                                <el-form :model="projectForm" label-width="120px">
                                    <el-form-item label="项目编号" required>
                                        <el-input v-model="projectForm.project_no" placeholder="如: PRJ001" :disabled="!!projectForm.id"></el-input>
                                    </el-form-item>
                                    <el-form-item label="项目名称" required>
                                        <el-input v-model="projectForm.name" placeholder="请输入项目名称"></el-input>
                                    </el-form-item>
                                    <el-form-item label="分类" required>
                                        <el-select v-model="projectForm.category_id" placeholder="请选择分类" style="width: 100%;">
                                            <el-option v-for="cat in categories" :key="cat.id" :label="cat.name" :value="cat.id"></el-option>
                                        </el-select>
                                    </el-form-item>
                                    <el-form-item label="原价" required>
                                        <el-input-number v-model="projectForm.original_price" :min="0" :precision="2" style="width: 100%;"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="现价" required>
                                        <el-input-number v-model="projectForm.current_price" :min="0" :precision="2" style="width: 100%;"></el-input-number>
                                    </el-form-item>
                                    <el-form-item label="单位">
                                        <el-input v-model="projectForm.unit" placeholder="如: 样品、次"></el-input>
                                    </el-form-item>
                                    <el-form-item label="服务周期">
                                        <div style="display: flex; gap: 10px; align-items: center;">
                                            <el-input-number v-model="projectForm.service_cycle_min" :min="1" placeholder="最短"></el-input-number>
                                            <span>~</span>
                                            <el-input-number v-model="projectForm.service_cycle_max" :min="1" placeholder="最长"></el-input-number>
                                            <span>工作日</span>
                                        </div>
                                    </el-form-item>
                                    <el-form-item label="仪器名称">
                                        <el-input v-model="projectForm.equipment_name" placeholder="请输入仪器名称"></el-input>
                                    </el-form-item>
                                    <el-form-item label="项目介绍">
                                        <el-input v-model="projectForm.introduction" type="textarea" :rows="3" placeholder="请输入项目介绍"></el-input>
                                    </el-form-item>
                                    <el-form-item label="样品要求">
                                        <el-input v-model="projectForm.sample_requirements" type="textarea" :rows="3" placeholder="请输入样品要求"></el-input>
                                    </el-form-item>
                                    <el-form-item label="封面图">
                                        <div>
                                            <el-input v-model="projectForm.cover_image" placeholder="图片URL" style="margin-bottom: 10px;"></el-input>
                                            <el-upload
                                                :action="uploadUrl"
                                                :headers="uploadHeaders"
                                                :on-success="handleProjectImageUpload"
                                                :show-file-list="false"
                                                accept="image/*">
                                                <el-button size="small" type="primary">上传封面图</el-button>
                                            </el-upload>
                                            <el-image 
                                                v-if="projectForm.cover_image"
                                                :src="projectForm.cover_image" 
                                                style="width: 100px; height: 100px; margin-top: 10px;"
                                                fit="cover">
                                            </el-image>
                                        </div>
                                    </el-form-item>
                                    <el-form-item label="标签">
                                        <el-checkbox v-model="projectForm.is_hot">热门</el-checkbox>
                                        <el-checkbox v-model="projectForm.is_recommended">推荐</el-checkbox>
                                    </el-form-item>
                                    <el-form-item label="排序">
                                        <el-input-number v-model="projectForm.sort_order" :min="0"></el-input-number>
                                    </el-form-item>
                                </el-form>
                                <template #footer>
                                    <el-button @click="projectDialogVisible = false">取消</el-button>
                                    <el-button type="primary" @click="saveProject" :loading="loading">保存</el-button>
                                </template>
                            </el-dialog>
                        </div>
                    </div>

                    <!-- 订单管理 -->
                    <div v-show="activeMenu === 'orders'">
                        <div class="page-header">
                            <h3>📦 订单管理</h3>
                        </div>
                        <div class="content-card">
                            <div style="margin-bottom: 16px; display: flex; justify-content: space-between;">
                                <div style="display: flex; gap: 10px;">
                                    <el-input
                                        v-model="orderSearch"
                                        placeholder="搜索订单号/用户手机号"
                                        style="width: 300px;"
                                        clearable
                                        @change="loadOrders">
                                        <template #prefix>
                                            <el-icon><search /></el-icon>
                                        </template>
                                    </el-input>
                                    <el-select v-model="orderStatusFilter" placeholder="订单状态" style="width: 150px;" @change="loadOrders" clearable>
                                        <el-option label="待支付" value="unpaid"></el-option>
                                        <el-option label="已支付" value="paid"></el-option>
                                        <el-option label="已确认" value="confirmed"></el-option>
                                        <el-option label="实验中" value="testing"></el-option>
                                        <el-option label="已完成" value="completed"></el-option>
                                        <el-option label="已取消" value="cancelled"></el-option>
                                    </el-select>
                                    <el-button type="primary" @click="loadOrders">搜索</el-button>
                                    <el-button @click="orderSearch=''; orderStatusFilter=null; loadOrders()">重置</el-button>
                                </div>
                            </div>

                            <el-table :data="orders" style="width: 100%" v-loading="ordersLoading">
                                <el-table-column prop="id" label="ID" width="80"></el-table-column>
                                <el-table-column prop="order_no" label="订单号" width="200"></el-table-column>
                                <el-table-column label="用户" width="150">
                                    <template #default="scope">
                                        <div>{{ scope.row.user_nickname }}</div>
                                        <div style="font-size: 12px; color: #999;">{{ scope.row.user_phone }}</div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="project_name" label="检测项目" width="200"></el-table-column>
                                <el-table-column label="样品" width="150">
                                    <template #default="scope">
                                        <div>{{ scope.row.sample_name }}</div>
                                        <div style="font-size: 12px; color: #999;">数量：{{ scope.row.quantity }}</div>
                                    </template>
                                </el-table-column>
                                <el-table-column label="金额" width="120">
                                    <template #default="scope">
                                        <span style="color: #ff4d4f; font-weight: 600;">¥{{ scope.row.total_amount }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="状态" width="100">
                                    <template #default="scope">
                                        <el-tag :type="getOrderStatusType(scope.row.status)" size="small">
                                            {{ getOrderStatusText(scope.row.status) }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column label="创建时间" width="180">
                                    <template #default="scope">
                                        {{ formatDateTime(scope.row.created_at) }}
                                    </template>
                                </el-table-column>
                                <el-table-column label="操作" width="200" fixed="right">
                                    <template #default="scope">
                                        <el-button link type="primary" size="small" @click="viewOrderDetail(scope.row)">详情</el-button>
                                        <el-button link type="warning" size="small" @click="showOrderStatusDialog(scope.row)">改状态</el-button>
                                    </template>
                                </el-table-column>
                            </el-table>

                            <el-pagination
                                v-model:current-page="orderPage"
                                v-model:page-size="orderPageSize"
                                :page-sizes="[10, 20, 50, 100]"
                                :total="orderTotal"
                                layout="total, sizes, prev, pager, next, jumper"
                                @size-change="loadOrders"
                                @current-change="loadOrders"
                                style="margin-top: 20px; justify-content: center;">
                            </el-pagination>
                        </div>
                    </div>

                    <!-- 系统设置 -->
                    <div v-show="activeMenu === 'settings'">
                        <div class="page-header">
                            <h3>⚙️ 系统设置</h3>
                        </div>
                        <div class="content-card">
                            <el-descriptions title="系统信息" :column="2" border>
                                <el-descriptions-item label="系统名称">科研检测服务平台</el-descriptions-item>
                                <el-descriptions-item label="版本">v1.0.0</el-descriptions-item>
                                <el-descriptions-item label="后端地址">{{ baseUrl }}</el-descriptions-item>
                                <el-descriptions-item label="当前管理员">{{ userInfo.nickname }}</el-descriptions-item>
                            </el-descriptions>
                        </div>
                    </div>
                </el-main>
            </el-container>
        </el-container>
    </div>

    <script>
        const { createApp } = Vue
        const { ElMessage, ElMessageBox } = ElementPlus

        createApp({
            data() {
                return {
                    baseUrl: 'https://catdog.dachaonet.com',
                    token: localStorage.getItem('admin_token') || '',
                    userInfo: JSON.parse(localStorage.getItem('admin_user') || '{}'),
                    loginType: 'admin',
                    adminLoginForm: {
                        username: '',
                        password: ''
                    },
                    loginForm: {
                        phone: '',
                        sms_code: ''
                    },
                    countdown: 0,
                    loading: false,
                    activeMenu: 'users', // 默认用户管理
                    uploadedImages: [],
                    users: [],
                    usersLoading: false,
                    userSearch: '',
                    userPage: 1,
                    userPageSize: 20,
                    userTotal: 0,
                    userDialogVisible: false,
                    selectedUser: null,
                    avatarUploadVisible: false,
                    currentEditUserId: null,
                    // 项目管理
                    projects: [],
                    projectsLoading: false,
                    projectSearch: '',
                    projectCategoryFilter: null,
                    projectPage: 1,
                    projectPageSize: 20,
                    projectTotal: 0,
                    projectDialogVisible: false,
                    projectForm: {
                        id: null,
                        name: '',
                        project_no: '',
                        category_id: null,
                        description: '',
                        original_price: '',
                        current_price: '',
                        cover_image: '',
                        is_hot: false,
                        is_recommended: false,
                        status: 'active'
                    },
                    categories: [],
                    // 订单管理
                    orders: [],
                    ordersLoading: false,
                    orderSearch: '',
                    orderStatusFilter: null,
                    orderPage: 1,
                    orderPageSize: 20,
                    orderTotal: 0
                }
            },
            computed: {
                uploadUrl() {
                    return `${this.baseUrl}/api/v1/upload/image`
                },
                uploadHeaders() {
                    return {
                        'Authorization': `Bearer ${this.token}`
                    }
                }
            },
            mounted() {
                if (this.token) {
                    this.loadUsers()
                    this.loadCategories()
                }
            },
            methods: {
                handleMenuSelect(index) {
                    this.activeMenu = index
                    if (index === 'users' && this.users.length === 0) {
                        this.loadUsers()
                    } else if (index === 'projects') {
                        this.loadProjects()
                    } else if (index === 'orders') {
                        this.loadOrders()
                    }
                },
                copyImageUrl(url) {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(url).then(() => {
                            ElMessage.success('图片URL已复制到剪贴板')
                        }).catch(() => {
                            ElMessage.error('复制失败')
                        })
                    } else {
                        // 兼容旧浏览器
                        const textarea = document.createElement('textarea')
                        textarea.value = url
                        document.body.appendChild(textarea)
                        textarea.select()
                        try {
                            document.execCommand('copy')
                            ElMessage.success('图片URL已复制到剪贴板')
                        } catch (err) {
                            ElMessage.error('复制失败')
                        }
                        document.body.removeChild(textarea)
                    }
                },
                async sendSms() {
                    if (!this.loginForm.phone) {
                        ElMessage.error('请输入手机号')
                        return
                    }
                    try {
                        const res = await axios.post(`${this.baseUrl}/api/v1/auth/send-sms`, {
                            phone: this.loginForm.phone,
                            scene: 'login'
                        })
                        ElMessage.success(res.data.message)
                        if (res.data.data && res.data.data.code) {
                            ElMessage.info(`开发模式验证码：${res.data.data.code}`)
                        }
                        this.countdown = 60
                        const timer = setInterval(() => {
                            this.countdown--
                            if (this.countdown <= 0) {
                                clearInterval(timer)
                            }
                        }, 1000)
                    } catch (error) {
                        ElMessage.error(error.response?.data?.detail || '发送失败')
                    }
                },
                async handleLogin() {
                    this.loading = true
                    try {
                        const res = await axios.post(`${this.baseUrl}/api/v1/auth/sms-login`, this.loginForm)
                        this.token = res.data.data.access_token
                        this.userInfo = {
                            id: res.data.data.user_id,
                            phone: res.data.data.phone,
                            nickname: res.data.data.nickname
                        }
                        localStorage.setItem('admin_token', this.token)
                        localStorage.setItem('admin_user', JSON.stringify(this.userInfo))
                        ElMessage.success('登录成功')
                        this.loadUsers()
                    } catch (error) {
                        ElMessage.error(error.response?.data?.detail || '登录失败')
                    } finally {
                        this.loading = false
                    }
                },
                async handleAdminLogin() {
                    if (!this.adminLoginForm.username || !this.adminLoginForm.password) {
                        ElMessage.error('请输入用户名和密码')
                        return
                    }
                    this.loading = true
                    try {
                        const res = await axios.post(`${this.baseUrl}/api/v1/auth/admin-login`, this.adminLoginForm)
                        this.token = res.data.data.access_token
                        this.userInfo = {
                            id: res.data.data.user_id,
                            phone: res.data.data.phone,
                            nickname: res.data.data.nickname,
                            is_admin: res.data.data.is_admin
                        }
                        localStorage.setItem('admin_token', this.token)
                        localStorage.setItem('admin_user', JSON.stringify(this.userInfo))
                        ElMessage.success('登录成功')
                        this.loadUsers()
                    } catch (error) {
                        ElMessage.error(error.response?.data?.detail || '登录失败')
                    } finally {
                        this.loading = false
                    }
                },
                logout() {
                    localStorage.removeItem('admin_token')
                    localStorage.removeItem('admin_user')
                    this.token = ''
                    this.userInfo = {}
                    ElMessage.success('已退出登录')
                },
                handleUploadSuccess(response, file) {
                    if (response.code === 200) {
                        ElMessage.success('上传成功')
                        this.uploadedImages.unshift({
                            url: response.data.url,
                            name: file.name
                        })
                    }
                },
                async handleAvatarUploadSuccess(response, file) {
                    if (response.code === 200) {
                        try {
                            // 更新用户头像
                            await axios.put(
                                `${this.baseUrl}/api/v1/users/me`,
                                { avatar: response.data.url },
                                { headers: this.uploadHeaders }
                            )
                            ElMessage.success('头像更新成功')
                            this.avatarUploadVisible = false
                            // 刷新用户详情
                            if (this.selectedUser) {
                                await this.viewUser({ id: this.selectedUser.id })
                            }
                            this.loadUsers()
                        } catch (error) {
                            ElMessage.error(error.response?.data?.detail || '头像更新失败')
                        }
                    }
                },
                handleUploadError(error) {
                    ElMessage.error('上传失败：' + (error.message || '未知错误'))
                },
                beforeUpload(file) {
                    const isImage = file.type.startsWith('image/')
                    const isLt10M = file.size / 1024 / 1024 < 10

                    if (!isImage) {
                        ElMessage.error('只能上传图片文件!')
                        return false
                    }
                    if (!isLt10M) {
                        ElMessage.error('图片大小不能超过 10MB!')
                        return false
                    }
                    return true
                },
                async deleteImage(imageUrl) {
                    try {
                        await ElMessageBox.confirm('确定要删除这张图片吗?', '提示', {
                            type: 'warning'
                        })
                        await axios.delete(`${this.baseUrl}/api/v1/upload/image`, {
                            headers: this.uploadHeaders,
                            params: { image_path: imageUrl }
                        })
                        this.uploadedImages = this.uploadedImages.filter(img => img.url !== imageUrl)
                        ElMessage.success('删除成功')
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error(error.response?.data?.detail || '删除失败')
                        }
                    }
                },
                async loadUsers() {
                    this.usersLoading = true
                    try {
                        const res = await axios.get(`${this.baseUrl}/api/v1/admin/users`, {
                            headers: this.uploadHeaders,
                            params: {
                                page: this.userPage,
                                page_size: this.userPageSize,
                                search: this.userSearch || undefined
                            }
                        })
                        this.users = res.data.data.list
                        this.userTotal = res.data.data.total
                    } catch (error) {
                        ElMessage.error(error.response?.data?.detail || '加载用户列表失败')
                    } finally {
                        this.usersLoading = false
                    }
                },
                async viewUser(user) {
                    try {
                        const res = await axios.get(`${this.baseUrl}/api/v1/users/${user.id}`, {
                            headers: this.uploadHeaders
                        })
                        this.selectedUser = res.data.data
                        this.userDialogVisible = true
                    } catch (error) {
                        ElMessage.error(error.response?.data?.detail || '加载用户详情失败')
                    }
                },
                async updateUserStatus(userId, status) {
                    const action = status === 'active' ? '激活' : '禁用'
                    try {
                        await ElMessageBox.confirm(`确定要${action}该用户吗?`, '提示', {
                            type: 'warning'
                        })
                        await axios.put(
                            `${this.baseUrl}/api/v1/users/${userId}/status`, 
                            null,
                            {
                                headers: this.uploadHeaders,
                                params: { status }
                            }
                        )
                        ElMessage.success(`${action}成功`)
                        this.loadUsers()
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error(error.response?.data?.detail || `${action}失败`)
                        }
                    }
                },
                getStatusText(status) {
                    const statusMap = {
                        'active': '正常',
                        'inactive': '未激活',
                        'banned': '已禁用'
                    }
                    return statusMap[status] || status
                },
                getMemberLevelText(level) {
                    const levelMap = {
                        0: '普通会员',
                        1: '银卡会员',
                        2: '金卡会员',
                        3: '白金会员'
                    }
                    return levelMap[level] || '普通会员'
                },
                formatDate(dateStr) {
                    if (!dateStr) return '-'
                    const date = new Date(dateStr)
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                },
                // 项目管理方法
                async loadCategories() {
                    try {
                        const res = await axios.get(`${this.baseUrl}/api/v1/projects/categories`)
                        this.categories = res.data.data || []
                    } catch (error) {
                        console.error('加载分类失败', error)
                    }
                },
                async loadProjects() {
                    this.projectsLoading = true
                    try {
                        const params = {
                            page: this.projectPage,
                            page_size: this.projectPageSize
                        }
                        if (this.projectSearch) {
                            params.search = this.projectSearch
                        }
                        if (this.projectCategoryFilter) {
                            params.category_id = this.projectCategoryFilter
                        }
                        const res = await axios.get(`${this.baseUrl}/api/v1/projects/list`, {
                            params,
                            headers: this.uploadHeaders
                        })
                        this.projects = res.data.data.items || []
                        this.projectTotal = res.data.data.total || 0
                    } catch (error) {
                        ElMessage.error(error.response?.data?.detail || '加载项目列表失败')
                    } finally {
                        this.projectsLoading = false
                    }
                },
                showProjectDialog(project = null) {
                    if (project) {
                        // 编辑项目
                        this.projectForm = { ...project }
                    } else {
                        // 新建项目
                        this.projectForm = {
                            id: null,
                            name: '',
                            project_no: '',
                            category_id: null,
                            description: '',
                            original_price: '',
                            current_price: '',
                            cover_image: '',
                            is_hot: false,
                            is_recommended: false,
                            status: 'active'
                        }
                    }
                    this.projectDialogVisible = true
                },
                async saveProject() {
                    if (!this.projectForm.name || !this.projectForm.project_no) {
                        ElMessage.error('请填写项目名称和编号')
                        return
                    }
                    this.loading = true
                    try {
                        if (this.projectForm.id) {
                            // 更新
                            await axios.put(
                                `${this.baseUrl}/api/v1/projects/${this.projectForm.id}`,
                                this.projectForm,
                                { headers: this.uploadHeaders }
                            )
                            ElMessage.success('更新成功')
                        } else {
                            // 创建
                            await axios.post(
                                `${this.baseUrl}/api/v1/projects/create`,
                                this.projectForm,
                                { headers: this.uploadHeaders }
                            )
                            ElMessage.success('创建成功')
                        }
                        this.projectDialogVisible = false
                        this.loadProjects()
                    } catch (error) {
                        ElMessage.error(error.response?.data?.detail || '保存失败')
                    } finally {
                        this.loading = false
                    }
                },
                async updateProjectStatus(projectId, status) {
                    const action = status === 'active' ? '上架' : '下架'
                    try {
                        await ElMessageBox.confirm(`确定要${action}该项目吗?`, '提示', {
                            type: 'warning'
                        })
                        await axios.put(
                            `${this.baseUrl}/api/v1/projects/${projectId}/status`,
                            null,
                            {
                                headers: this.uploadHeaders,
                                params: { status }
                            }
                        )
                        ElMessage.success(`${action}成功`)
                        this.loadProjects()
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error(error.response?.data?.detail || `${action}失败`)
                        }
                    }
                },
                async deleteProject(projectId) {
                    try {
                        await ElMessageBox.confirm('确定要删除该项目吗? 此操作不可恢复!', '警告', {
                            type: 'error',
                            confirmButtonText: '确定删除',
                            cancelButtonText: '取消'
                        })
                        await axios.delete(
                            `${this.baseUrl}/api/v1/projects/${projectId}`,
                            { headers: this.uploadHeaders }
                        )
                        ElMessage.success('删除成功')
                        this.loadProjects()
                    } catch (error) {
                        if (error !== 'cancel') {
                            ElMessage.error(error.response?.data?.detail || '删除失败')
                        }
                    }
                },
                handleProjectImageUpload(response, file) {
                    if (response.code === 200) {
                        this.projectForm.cover_image = response.data.url
                        ElMessage.success('封面图片上传成功')
                    }
                },
                
                // ==================== 订单管理 ====================
                async loadOrders() {
                    this.ordersLoading = true
                    try {
                        const res = await axios.get(`${this.baseUrl}/api/v1/admin/orders`, {
                            headers: this.uploadHeaders,
                            params: {
                                page: this.orderPage,
                                page_size: this.orderPageSize,
                                search: this.orderSearch || undefined,
                                status: this.orderStatusFilter || undefined
                            }
                        })
                        this.orders = res.data.data.items || []
                        this.orderTotal = res.data.data.total || 0
                    } catch (error) {
                        console.error('加载订单失败', error)
                        ElMessage.error(error.response?.data?.detail || '加载订单失败')
                    } finally {
                        this.ordersLoading = false
                    }
                },
                viewOrderDetail(order) {
                    ElMessageBox.alert(`
                        <div style="line-height: 1.8;">
                            <p><strong>订单号：</strong>${order.order_no}</p>
                            <p><strong>用户：</strong>${order.user_nickname} (${order.user_phone})</p>
                            <p><strong>项目：</strong>${order.project_name}</p>
                            <p><strong>样品：</strong>${order.sample_name} × ${order.quantity}</p>
                            <p><strong>金额：</strong>¥${order.total_amount}</p>
                            <p><strong>状态：</strong>${this.getOrderStatusText(order.status)}</p>
                            <p><strong>创建时间：</strong>${this.formatDateTime(order.created_at)}</p>
                            ${order.paid_at ? `<p><strong>支付时间：</strong>${this.formatDateTime(order.paid_at)}</p>` : ''}
                        </div>
                    `, '订单详情', {
                        dangerouslyUseHTMLString: true,
                        confirmButtonText: '关闭'
                    })
                },
                showOrderStatusDialog(order) {
                    ElMessageBox.prompt('请输入新状态', '修改订单状态', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        inputPlaceholder: 'unpaid/paid/confirmed/testing/completed/cancelled',
                        inputValue: order.status
                    }).then(async ({ value }) => {
                        try {
                            await axios.put(
                                `${this.baseUrl}/api/v1/admin/orders/${order.id}/status`,
                                null,
                                {
                                    headers: this.uploadHeaders,
                                    params: { new_status: value }
                                }
                            )
                            ElMessage.success('状态修改成功')
                            this.loadOrders()
                        } catch (error) {
                            ElMessage.error(error.response?.data?.detail || '状态修改失败')
                        }
                    }).catch(() => {})
                },
                getOrderStatusText(status) {
                    const statusMap = {
                        'unpaid': '待支付',
                        'paid': '已支付',
                        'confirmed': '已确认',
                        'testing': '实验中',
                        'completed': '已完成',
                        'cancelled': '已取消'
                    }
                    return statusMap[status] || status
                },
                getOrderStatusType(status) {
                    const typeMap = {
                        'unpaid': 'warning',
                        'paid': 'info',
                        'confirmed': 'primary',
                        'testing': 'primary',
                        'completed': 'success',
                        'cancelled': 'danger'
                    }
                    return typeMap[status] || 'info'
                },
                formatDateTime(dateStr) {
                    if (!dateStr) return '-'
                    const date = new Date(dateStr)
                    return date.toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                }
            }
        }).use(ElementPlus).mount('#app')
    </script>
</body>
</html>
