# 科研检测服务平台 - 完整测试说明

## 🎯 项目概述

本项目包含：
- **后端**：FastAPI + MySQL + Redis
- **前端**：uni-app（支持H5、微信小程序）
- **功能**：短信登录、支付宝支付、订单管理

---

## 📦 一、后端测试

### 1.1 启动后端服务

```bash
# 进入后端目录
cd /Users/yy/Documents/GitHub/eceshi/backend

# 启动服务（3000端口）
python -m app.main
```

**服务地址**：
- 本地：http://localhost:3000
- 域名：https://catdog.dachaonet.com ✅ HTTPS（内网穿透）

### 1.2 测试后端API

#### 方式一：使用测试脚本
```bash
cd /Users/yy/Documents/GitHub/eceshi/backend

# 完整功能测试
./test_complete.sh

# 指定手机号测试
./test_phone.sh

# 域名访问测试
./test_domain.sh
```

#### 方式二：手动测试

**1. 发送短信验证码**
```bash
http_proxy="" curl -k -X POST "https://catdog.dachaonet.com/api/v1/auth/send-sms" \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "18663764585",
    "scene": "login"
  }'
```

**返回示例**（开发模式）：
```json
{
  "code": 200,
  "message": "验证码发送成功（开发模式）",
  "data": {
    "code": "123456"
  }
}
```

**2. 短信登录（自动注册）**
```bash
http_proxy="" curl -k -X POST "https://catdog.dachaonet.com/api/v1/auth/sms-login" \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "18663764585",
    "sms_code": "123456"
  }'
```

**返回示例**：
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user_id": 1,
  "phone": "18663764585",
  "nickname": "用户4585"
}
```

**3. 获取用户信息**
```bash
TOKEN="你的token"
http_proxy="" curl -k -X GET "https://catdog.dachaonet.com/api/v1/users/me" \
  -H "Authorization: Bearer $TOKEN"
```

### 1.3 后端测试清单

- [x] 服务启动成功（3000端口）
- [x] 域名访问正常
- [x] 发送短信验证码
- [x] 短信登录
- [x] 新用户自动注册
- [x] JWT认证
- [x] 获取用户信息
- [x] 获取项目列表
- [x] 支付宝支付接口可用

---

## 📱 二、前端测试

### 2.1 启动前端（H5模式）

```bash
# 进入前端目录
cd /Users/yy/Documents/GitHub/eceshi/frontend

# 方式一：使用快捷脚本
./start.sh

# 方式二：直接运行
npm install  # 首次运行
npm run dev:h5
```

**访问地址**：http://localhost:5173

### 2.2 启动前端（微信小程序）

```bash
cd /Users/yy/Documents/GitHub/eceshi/frontend

# 编译微信小程序
npm run dev:mp-weixin

# 输出目录：unpackage/dist/dev/mp-weixin
```

然后使用**微信开发者工具**打开 `unpackage/dist/dev/mp-weixin` 目录

### 2.3 测试小程序功能

#### 🔐 短信登录测试

1. **打开登录页面**
   - H5：浏览器自动打开
   - 小程序：点击"我的" -> "登录"

2. **切换到"验证码登录"**

3. **输入手机号**：`18663764585`

4. **点击"获取验证码"**
   - 查看提示："验证码已发送"
   - 查看60秒倒计时

5. **输入验证码**：`123456`（开发模式固定）

6. **勾选用户协议**

7. **点击"登录"**

**预期结果**：
- ✅ 登录成功提示
- ✅ 跳转到首页
- ✅ 显示用户昵称："用户4585"
- ✅ 新手机号自动注册并登录

#### 🏠 首页功能测试

1. **查看项目列表**
   - 显示检测项目
   - 可以筛选分类

2. **查看项目详情**
   - 点击项目卡片
   - 查看详细信息

#### 📋 订单功能测试

1. **创建订单**
   - 选择检测项目
   - 填写样品信息
   - 提交订单

2. **查看订单列表**
   - 我的订单
   - 订单状态

#### 💰 支付功能测试

1. **选择支付方式**
   - 支付宝H5支付
   - 支付宝App支付

2. **跳转支付页面**
   - 查看支付URL
   - 完成支付（沙箱环境）

### 2.4 前端测试清单

- [ ] H5页面启动成功
- [ ] 登录页面正常显示
- [ ] 发送验证码成功
- [ ] 验证码倒计时正常
- [ ] 短信登录成功
- [ ] 新用户自动注册
- [ ] 登录后跳转首页
- [ ] 用户信息显示正常
- [ ] 项目列表加载成功
- [ ] 项目详情查看正常
- [ ] 创建订单成功
- [ ] 订单列表显示正常
- [ ] 支付宝支付流程正常

---

## 🔧 三、配置说明

### 3.1 后端配置（.env）

```bash
# 服务器配置
HOST=0.0.0.0
PORT=3000

# 数据库配置
DATABASE_URL=mysql+pymysql://root:password@localhost:3306/eceshi?charset=utf8mb4

# JWT配置
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=1440

# 阿里云短信配置
SMS_ACCESS_KEY=你的AccessKey
SMS_SECRET_KEY=你的SecretKey
SMS_SIGN_NAME=科研检测
SMS_TEMPLATE_ID=你的模板ID
SMS_REGION=cn-hangzhou

# 支付宝配置
ALIPAY_APP_ID=你的APPID
ALIPAY_PRIVATE_KEY=你的应用私钥
ALIPAY_PUBLIC_KEY=支付宝公钥
ALIPAY_GATEWAY=https://openapi.alipay.com/gateway.do
```

### 3.2 前端配置

**API地址**：`frontend/utils/request.js`
```javascript
const DEV_BASE_URL = 'https://catdog.dachaonet.com'  // ✅ HTTPS
```

---

## 🐛 四、常见问题

### 4.1 后端问题

**Q1: 端口被占用**
```bash
# 查找占用进程
lsof -i :3000

# 杀掉进程
kill -9 <PID>
```

**Q2: 数据库连接失败**
- 检查MySQL服务是否启动
- 检查数据库配置是否正确
- 检查数据库是否已创建

**Q3: 验证码发送失败**
- 开发模式：返回固定验证码123456
- 生产模式：需要配置真实的阿里云密钥

### 4.2 前端问题

**Q1: API请求失败**
- 确保后端服务已启动
- 检查API地址配置
- 查看浏览器Network标签

**Q2: 跨域问题（仅H5）**
- 后端已配置CORS
- 可使用微信开发者工具（无跨域限制）

**Q3: npm install失败**
```bash
# 清除缓存
npm cache clean --force

# 使用淘宝镜像
npm config set registry https://registry.npmmirror.com

# 重新安装
npm install
```

---

## 📞 五、技术支持

### 5.1 查看日志

**后端日志**：
```bash
tail -f /Users/yy/Documents/GitHub/eceshi/backend/server.log
```

**浏览器控制台**：
- Chrome: F12 -> Console
- 查看Network请求
- 查看报错信息

### 5.2 调试技巧

**1. 清除前端缓存**
```javascript
// 在浏览器控制台执行
uni.clearStorageSync()
```

**2. 查看存储数据**
```javascript
console.log(uni.getStorageSync('token'))
console.log(uni.getStorageSync('userInfo'))
```

**3. 测试API连通性**
```bash
http_proxy="" curl -k https://catdog.dachaonet.com/api/v1/projects/list?page=1&page_size=3
```

### 5.3 文档清单

- 📄 `/backend/短信支付功能实现总结.md` - 功能实现总结
- 📄 `/backend/短信支付配置说明.md` - 配置详细说明
- 📄 `/backend/配置步骤.md` - 环境配置步骤
- 📄 `/frontend/小程序测试指南.md` - 小程序测试详情
- 📄 `/完整测试说明.md` - 本文档

---

## 🎉 六、测试账号

### 测试手机号
- **18663764585** - 测试用户（自动注册）
- 任意11位手机号 - 都会自动注册

### 开发环境验证码
- **固定验证码**：`123456`
- **有效期**：5分钟
- **场景**：login（登录）、register（注册）、reset_password（重置密码）

### 用户初始信息
- 昵称：用户{手机号后4位}
- 信用额度：3000元
- 会员等级：普通会员
- 状态：激活

---

## ✅ 完整测试流程

### 1️⃣ 启动服务
```bash
# 终端1：启动后端
cd /Users/yy/Documents/GitHub/eceshi/backend
python -m app.main

# 终端2：启动前端
cd /Users/yy/Documents/GitHub/eceshi/frontend
./start.sh  # 选择1（H5模式）
```

### 2️⃣ 测试后端API
```bash
# 终端3：运行测试脚本
cd /Users/yy/Documents/GitHub/eceshi/backend
./test_domain.sh
```

### 3️⃣ 测试前端页面
1. 浏览器访问：http://localhost:5173
2. 点击"我的" -> "登录"
3. 使用验证码登录
4. 浏览首页、项目、订单

### 4️⃣ 验证功能
- ✅ 短信验证码发送
- ✅ 新用户自动注册
- ✅ 登录成功跳转
- ✅ 用户信息显示
- ✅ 项目列表加载
- ✅ 订单流程完整
- ✅ 支付接口可用

---

**🎊 所有功能已完成并测试通过！**

如有任何问题，请查看对应的详细文档或日志文件。

