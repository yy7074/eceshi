# 功能测试指南

## 🚀 快速开始

### 1. 启动后端服务

```bash
# 进入后端目录
cd /Users/yy/Documents/GitHub/eceshi/backend

# 启动服务（如果还没启动）
uvicorn app.main:app --reload

# 看到这样的输出表示成功：
# INFO:     Uvicorn running on http://0.0.0.0:8000
```

**服务地址**:
- API文档: http://localhost:8000/api/docs
- 健康检查: http://localhost:8000/health

---

## 📋 测试方式

### 方式1：使用 Swagger API 文档（推荐）

1. 访问 http://localhost:8000/api/docs
2. 可以直接在网页上测试所有接口
3. 先测试登录获取Token
4. 使用Token测试其他接口

### 方式2：使用 curl 命令

直接在终端测试API

### 方式3：前端页面测试

使用HBuilderX运行前端页面

---

## 🧪 完整测试流程

### 第一步：用户注册和登录

```bash
# 1. 发送验证码
curl -X POST http://localhost:8000/api/v1/auth/send-sms \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000"
  }'

# 2. 注册用户（验证码开发模式固定为123456）
curl -X POST http://localhost:8000/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "password": "123456",
    "sms_code": "123456"
  }'

# 3. 登录获取Token
curl -X POST http://localhost:8000/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13800138000",
    "password": "123456"
  }'

# 记录返回的 access_token，后续请求需要用到
```

### 第二步：添加收货地址

```bash
# 替换 YOUR_TOKEN 为上一步获取的token
export TOKEN="YOUR_TOKEN"

# 添加地址
curl -X POST http://localhost:8000/api/v1/addresses/add \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "receiver_name": "张三",
    "phone": "13800138000",
    "province": "北京市",
    "city": "北京市",
    "district": "海淀区",
    "detail_address": "清华大学",
    "is_default": true
  }'

# 查看地址列表
curl -X GET http://localhost:8000/api/v1/addresses/list \
  -H "Authorization: Bearer $TOKEN"
```

### 第三步：计算订单费用

```bash
# 计算费用
curl -X POST http://localhost:8000/api/v1/orders/calculate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "project_id": 1,
    "sample_count": 2,
    "is_urgent": false,
    "shipping_method": "express",
    "coupon_id": null,
    "use_points": 0
  }'
```

### 第四步：创建订单

```bash
# 创建订单（记录地址ID）
curl -X POST http://localhost:8000/api/v1/orders/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "project_id": 1,
    "samples": [
      {
        "sample_name": "样品A",
        "sample_type": "粉末",
        "sample_desc": "白色粉末，用于SEM检测",
        "quantity": 1,
        "photos": [],
        "test_params": {},
        "special_requirements": "加急处理"
      }
    ],
    "shipping_method": "express",
    "address_id": 1,
    "is_urgent": false,
    "remark": "请尽快处理"
  }'

# 记录返回的 order_id
```

### 第五步：查看订单

```bash
# 查看订单列表
curl -X GET "http://localhost:8000/api/v1/orders/list?status=all&page=1&page_size=10" \
  -H "Authorization: Bearer $TOKEN"

# 查看订单详情（替换 ORDER_ID）
curl -X GET http://localhost:8000/api/v1/orders/1 \
  -H "Authorization: Bearer $TOKEN"
```

### 第六步：支付订单

```bash
# 余额支付（替换 ORDER_ID）
curl -X POST http://localhost:8000/api/v1/payments/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "order_id": 1,
    "payment_method": "balance",
    "payment_password": "123456"
  }'
```

### 第七步：取消订单（可选）

```bash
# 取消订单（仅待支付状态可取消）
curl -X POST http://localhost:8000/api/v1/orders/1/cancel \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "reason": "不想买了"
  }'
```

---

## 🎨 前端页面测试

### 使用 HBuilderX

1. **打开项目**
   - 启动 HBuilderX
   - 文件 → 导入 → 从本地目录导入
   - 选择 `/Users/yy/Documents/GitHub/eceshi/frontend`

2. **运行到浏览器**
   - 运行 → 运行到浏览器 → Chrome
   - 会自动打开 http://localhost:8080

3. **测试流程**
   ```
   第1步：注册/登录
   - 点击"我的" Tab
   - 点击"点击登录/注册"
   - 注册账号：13800138001 / 密码123456 / 验证码123456
   - 或直接登录已有账号
   
   第2步：浏览项目
   - 返回首页
   - 查看项目列表
   - 点击某个项目查看详情
   
   第3步：下单
   - 在项目详情页点击"立即预约"
   - 填写样品信息（名称、类型、数量等）
   - 点击"下一步"
   - 选择配送方式
   - 如选择快递，需要先添加地址
   - 点击"下一步"
   - 查看费用明细，可选择加急
   - 点击"提交订单"
   
   第4步：支付
   - 选择余额支付
   - 输入支付密码（与登录密码相同：123456）
   - 点击"确认支付"
   - 支付成功
   
   第5步：查看订单
   - 点击"订单" Tab
   - 查看订单列表
   - 点击订单查看详情
   ```

---

## 🔧 使用一键测试脚本

```bash
cd /Users/yy/Documents/GitHub/eceshi

# 创建测试脚本
cat > test.sh << 'SCRIPT'
#!/bin/bash

BASE_URL="http://localhost:8000/api/v1"
TOKEN=""

echo "🧪 开始测试..."

# 1. 注册
echo -e "\n📝 1. 注册用户..."
REGISTER_RES=$(curl -s -X POST ${BASE_URL}/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13900139000",
    "password": "123456",
    "sms_code": "123456"
  }')
echo $REGISTER_RES | python3 -m json.tool

# 2. 登录
echo -e "\n🔐 2. 登录获取Token..."
LOGIN_RES=$(curl -s -X POST ${BASE_URL}/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "phone": "13900139000",
    "password": "123456"
  }')
echo $LOGIN_RES | python3 -m json.tool
TOKEN=$(echo $LOGIN_RES | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['access_token'])" 2>/dev/null)

if [ -z "$TOKEN" ]; then
  echo "❌ 登录失败，无法获取Token"
  exit 1
fi

echo "✅ Token: ${TOKEN:0:20}..."

# 3. 添加地址
echo -e "\n📍 3. 添加收货地址..."
curl -s -X POST ${BASE_URL}/addresses/add \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "receiver_name": "测试用户",
    "phone": "13900139000",
    "province": "北京市",
    "city": "北京市",
    "district": "海淀区",
    "detail_address": "中关村大街1号",
    "is_default": true
  }' | python3 -m json.tool

# 4. 创建订单
echo -e "\n📦 4. 创建订单..."
ORDER_RES=$(curl -s -X POST ${BASE_URL}/orders/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "project_id": 1,
    "samples": [
      {
        "sample_name": "测试样品",
        "sample_type": "粉末",
        "sample_desc": "白色粉末",
        "quantity": 1
      }
    ],
    "shipping_method": "express",
    "address_id": 1,
    "is_urgent": false,
    "remark": "测试订单"
  }')
echo $ORDER_RES | python3 -m json.tool
ORDER_ID=$(echo $ORDER_RES | python3 -c "import sys, json; print(json.load(sys.stdin)['data']['order_id'])" 2>/dev/null)

if [ -z "$ORDER_ID" ]; then
  echo "❌ 创建订单失败"
  exit 1
fi

echo "✅ 订单ID: $ORDER_ID"

# 5. 支付订单
echo -e "\n💰 5. 余额支付..."
curl -s -X POST ${BASE_URL}/payments/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d "{
    \"order_id\": $ORDER_ID,
    \"payment_method\": \"balance\",
    \"payment_password\": \"123456\"
  }" | python3 -m json.tool

# 6. 查看订单列表
echo -e "\n📋 6. 查看订单列表..."
curl -s -X GET "${BASE_URL}/orders/list?status=all" \
  -H "Authorization: Bearer $TOKEN" | python3 -m json.tool

echo -e "\n✅ 测试完成！"
SCRIPT

chmod +x test.sh

# 运行测试
./test.sh
```

---

## 📊 验证清单

### 后端API验证
- [ ] 用户注册成功
- [ ] 用户登录获取Token
- [ ] 添加地址成功
- [ ] 地址列表正确显示
- [ ] 计算订单费用正确
- [ ] 创建订单成功
- [ ] 订单列表正确显示
- [ ] 订单详情正确
- [ ] 余额支付成功
- [ ] 订单状态更新为已支付
- [ ] 取消订单成功（待支付状态）

### 前端页面验证
- [ ] 登录注册流程正常
- [ ] 项目详情页面显示正确
- [ ] 下单页面步骤流程顺畅
- [ ] 样品信息填写正常
- [ ] 配送方式选择正常
- [ ] 地址管理功能正常
- [ ] 费用计算显示正确
- [ ] 支付页面功能正常
- [ ] 支付成功跳转正确
- [ ] 订单列表显示正常

### 数据库验证
```bash
# 连接数据库查看
mysql -u root -p123456

USE eceshi;

# 查看订单
SELECT * FROM orders ORDER BY created_at DESC LIMIT 5;

# 查看样品
SELECT * FROM order_samples ORDER BY created_at DESC LIMIT 5;

# 查看支付记录
SELECT * FROM payments ORDER BY created_at DESC LIMIT 5;

# 查看地址
SELECT * FROM user_addresses ORDER BY created_at DESC LIMIT 5;
```

---

## 🐛 常见问题

### 1. 后端启动失败
```bash
# 检查端口占用
lsof -i :8000

# 检查数据库连接
mysql -u root -p123456 -e "SHOW DATABASES;"
```

### 2. Token认证失败
- 确保登录成功获取了Token
- 检查Token格式：`Bearer YOUR_TOKEN`
- Token有效期检查（默认24小时）

### 3. 订单创建失败
- 检查是否已登录
- 检查地址ID是否正确
- 检查项目ID是否存在

### 4. 支付失败
- 检查订单状态（必须是待支付）
- 检查支付密码是否正确
- 检查余额是否充足（模拟余额1000元）

---

## 📝 测试数据

### 测试账号
- 手机号：13800138000
- 密码：123456
- 验证码：123456（开发模式固定）

### 模拟项目
- 项目ID：1
- 项目名称：场发射扫描电镜（SEM）
- 单价：¥312.00

### 模拟余额
- 用户余额：¥1000.00（硬编码）

---

**祝测试顺利！** 🎉
